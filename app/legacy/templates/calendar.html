<!DOCTYPE html>
<html lang="en">

<div class="calendar-container fade-in">
    <!-- Header -->
    <div class="calendar-header">
        <h1><i class="fas fa-calendar-alt me-3"></i>Attendance Calendar</h1>
        <p>Track tutor attendance and session details with our interactive calendar view</p>
    </div>

    <!-- Controls -->
    <div class="calendar-controls">
        <div class="month-navigation">
            <button class="nav-btn" onclick="previousMonth()">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div class="current-month" id="currentMonth">Loading...</div>
            <button class="nav-btn" onclick="nextMonth()">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        <button class="today-btn" onclick="goToToday()">
            <i class="fas fa-calendar-day me-2"></i>Today
        </button>
    </div>

    <!-- Calendar Grid -->
    <div id="calendarDays" class="calendar-grid">
        <!-- Headers and days will be populated here by JS -->
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
    </div>
</div>
</div>
</div>
</div>

<!-- Day Details Modal -->
<div class="modal fade" id="dayModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dayModalTitle">
                    <i class="fas fa-calendar-day me-2"></i>Day Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="dayModalBody">
                <!-- Day details will be populated here -->
            </div>
        </div>
    </div>
</div>

<!-- Photo Modal -->
<div class="modal fade photo-modal" id="photoModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-image me-2"></i>Session Photo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <img id="photoModalImage" src="" alt="Session Photo">
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentDate = new Date();
    let currentYear = currentDate.getFullYear();
    let currentMonth = currentDate.getMonth();

    // Initialize calendar
    document.addEventListener('DOMContentLoaded', function () {
        loadCalendar();
    });

    function loadCalendar() {
        showLoading();

        fetch(`{{ url_for('legacy.api_calendar_data') }}?year=${currentYear}&month=${currentMonth + 1}`)
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.error) {
                    showError(data.error);
                    return;
                }
                renderCalendar(data);
            })
            .catch(error => {
                hideLoading();
                showError('Failed to load calendar data: ' + error.message);
            });
    }

    function renderCalendar(data) {
        const calendarDays = document.getElementById('calendarDays');
        const currentMonthElement = document.getElementById('currentMonth');

        // Update month display
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'];
        currentMonthElement.textContent = `${monthNames[currentMonth]} ${currentYear}`;

        // Clear existing days
        calendarDays.innerHTML = '';

        // Add weekday headers as the first 7 grid cells
        const weekHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        weekHeaders.forEach(day => {
            const header = document.createElement('div');
            header.className = 'calendar-day-header';
            header.textContent = day;
            calendarDays.appendChild(header);
        });

        // Defensive: Check if data.days exists
        if (!data.days) {
            showError('No calendar data available for this month.');
            return;
        }

        // Get first day of month and number of days
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const today = new Date();

        // Add empty cells for days before month starts
        for (let i = 0; i < firstDay; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day other-month';
            calendarDays.appendChild(emptyDay);
        }

        // Add days of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';

            // Check if this is today
            if (day === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear()) {
                dayElement.classList.add('today');
            }

            const dayData = data.days[day];
            if (dayData) {
                dayElement.onclick = () => showDayDetails(day, dayData);

                // Add issue indicator if there are problems
                if (dayData.has_issues) {
                    const issueIndicator = document.createElement('div');
                    issueIndicator.className = 'issue-indicator';
                    dayElement.appendChild(issueIndicator);
                }
            }

            dayElement.innerHTML = `
                    <div class="day-number">${day}</div>
                    ${dayData ? `
                        <div class="day-status">
                            <span class="status-indicator status-${dayData.status}"></span>
                        </div>
                        <div class="day-summary">
                            ${dayData.sessions} sessions<br>
                            ${dayData.total_hours.toFixed(1)}h
                        </div>
                    ` : `
                        <div class="day-summary">No data</div>
                    `}
                `;

            calendarDays.appendChild(dayElement);
        }
    }

    function showDayDetails(day, dayData) {
        const modal = new bootstrap.Modal(document.getElementById('dayModal'));
        const modalTitle = document.getElementById('dayModalTitle');
        const modalBody = document.getElementById('dayModalBody');

        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'];

        modalTitle.innerHTML = `<i class="fas fa-calendar-day me-2"></i>${monthNames[currentMonth]} ${day}, ${currentYear}`;

        // Debug: Log the dayData to console
        console.log('Day data:', dayData);
        console.log('Sessions data:', dayData.sessions_data);

        let sessionsHtml = '';
        if (dayData.sessions_data && dayData.sessions_data.length > 0) {
            dayData.sessions_data.forEach(session => {
                const statusClass = getSessionStatusClass(session);
                const statusText = getSessionStatusText(session);

                sessionsHtml += `
                        <div class="session-card slide-in">
                            <div class="session-header">
                                <div class="tutor-info">
                                    <div class="tutor-avatar">
                                        ${session.tutor_name ? session.tutor_name.charAt(0).toUpperCase() : 'T'}
                                    </div>
                                    <div class="tutor-details">
                                        <h5>${session.tutor_name || 'Unknown Tutor'}</h5>
                                        <p>Tutor ID: ${session.tutor_id}</p>
                                    </div>
                                </div>
                                <span class="session-status ${statusClass}">${statusText}</span>
                            </div>
                            
                            <div class="session-details">
                                <div class="detail-item">
                                    <i class="fas fa-clock detail-icon"></i>
                                    <span class="detail-label">Duration:</span>
                                    <span class="detail-value">${parseFloat(session.shift_hours).toFixed(1)} hours</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-sign-in-alt detail-icon"></i>
                                    <span class="detail-label">Check-in:</span>
                                    <span class="detail-value">${formatDateTime(session.check_in)}</span>
                                </div>
                                ${session.check_out ? `
                                    <div class="detail-item">
                                        <i class="fas fa-sign-out-alt detail-icon"></i>
                                        <span class="detail-label">Check-out:</span>
                                        <span class="detail-value">${formatDateTime(session.check_out)}</span>
                                    </div>
                                ` : ''}
                                <div class="detail-item">
                                    <i class="fas fa-calendar-day detail-icon"></i>
                                    <span class="detail-label">Day:</span>
                                    <span class="detail-value">${getDayName(session.check_in)}</span>
                                </div>
                            </div>
                            
                            ${session.snapshot_in ? `
                                <div class="session-photos">
                                    <div class="photo-item" onclick="showPhoto('${session.snapshot_in}')">
                                        <img src="/static/snapshots/${session.snapshot_in}" alt="Session Photo">
                                        <div class="photo-overlay">
                                            <i class="fas fa-expand"></i>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
            });
        } else {
            sessionsHtml = `
                    <div class="text-center py-4">
                        <i class="fas fa-calendar-times fa-3x mb-3" style="color: var(--text-muted);"></i>
                        <h5 style="color: var(--text-muted);">No sessions recorded</h5>
                        <p style="color: var(--text-muted);">No tutor sessions were recorded for this day.</p>
                    </div>
                `;
        }

        modalBody.innerHTML = `
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="text-center p-3" style="background: var(--bg-secondary); border-radius: 12px;">
                            <i class="fas fa-users fa-2x text-primary mb-2"></i>
                            <h4 style="color: var(--text-primary);">${dayData.sessions}</h4>
                            <p style="color: var(--text-secondary); margin-bottom: 0;">Total Sessions</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3" style="background: var(--bg-secondary); border-radius: 12px;">
                            <i class="fas fa-clock fa-2x text-success mb-2"></i>
                            <h4 style="color: var(--text-primary);">${dayData.total_hours.toFixed(1)}h</h4>
                            <p style="color: var(--text-secondary); margin-bottom: 0;">Total Hours</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3" style="background: var(--bg-secondary); border-radius: 12px;">
                            <i class="fas fa-user-graduate fa-2x text-warning mb-2"></i>
                            <h4 style="color: var(--text-primary);">${dayData.tutors}</h4>
                            <p style="color: var(--text-secondary); margin-bottom: 0;">Active Tutors</p>
                        </div>
                    </div>
                </div>
                <h5 class="mb-3" style="color: var(--text-primary);"><i class="fas fa-list me-2"></i>Session Details</h5>
                ${sessionsHtml}
            `;

        modal.show();
    }

    function showPhoto(photoPath) {
        const modal = new bootstrap.Modal(document.getElementById('photoModal'));
        const photoImage = document.getElementById('photoModalImage');
        // Extract just the filename from the path
        const filename = photoPath.split('/').pop();
        photoImage.src = `/static/snapshots/${filename}`;
        modal.show();
    }

    function getSessionStatusClass(session) {
        if (!session.check_out) return 'status-danger';
        if (parseFloat(session.shift_hours) < 1) return 'status-warning';
        return 'status-normal';
    }

    function getSessionStatusText(session) {
        if (!session.check_out) return 'No Checkout';
        if (parseFloat(session.shift_hours) < 1) return 'Short Shift';
        return 'Normal';
    }

    function formatDateTime(dateTimeStr) {
        if (!dateTimeStr) return 'N/A';
        const date = new Date(dateTimeStr);
        return date.toLocaleString();
    }

    function getDayName(dateTimeStr) {
        if (!dateTimeStr) return 'N/A';
        const date = new Date(dateTimeStr);
        return date.toLocaleDateString('en-US', { weekday: 'long' });
    }

    function previousMonth() {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        loadCalendar();
    }

    function nextMonth() {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        loadCalendar();
    }

    function goToToday() {
        const today = new Date();
        currentYear = today.getFullYear();
        currentMonth = today.getMonth();
        loadCalendar();
    }

    function showLoading() {
        document.getElementById('loadingOverlay').style.display = 'flex';
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    function showError(message) {
        const calendarDays = document.getElementById('calendarDays');
        calendarDays.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${message}
                </div>
            `;
    }
</script>
</body>

</html>