<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ‘¥ User Management - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .user-card {
            transition: all 0.3s ease;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }
        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .role-badge {
            font-size: 0.75rem;
            padding: 0.5rem 0.75rem;
            border-radius: 20px;
        }
        .role-admin { background: linear-gradient(135deg, #dc3545, #c82333); }
        .role-manager { background: linear-gradient(135deg, #fd7e14, #e55a00); }
        .role-lead_tutor { background: linear-gradient(135deg, #ffc107, #e0a800); }
        .role-tutor { background: linear-gradient(135deg, #17a2b8, #138496); }
        .admin-only { display: none; }
    </style>
</head>
<body class="bg-light">
<script src="/static/js/admin_navbar.js"></script>
    <div class="container py-4">
        <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#usersPane" type="button" role="tab">Users</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="audit-tab" data-bs-toggle="tab" data-bs-target="#auditPane" type="button" role="tab">Audit Logs</button>
            </li>
        </ul>
        <div class="tab-content" id="adminTabsContent">
            <div class="tab-pane fade show active" id="usersPane" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="fw-bold text-primary mb-1">ðŸ‘¥ User Management</h2>
                        <p class="text-muted mb-0">Manage tutor accounts, roles, and permissions</p>
                    </div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createUserModal">
                        <i class="fas fa-plus-circle"></i> Add New User
                    </button>
                </div>

                <!-- Flash Messages -->
                <div id="flashMessages">
                    <!-- Flash messages will be populated here -->
                </div>

                <!-- Users Grid -->
                <div class="row g-4" id="usersGrid">
                    <!-- Users will be populated here -->
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="text-center py-5" style="display: none;">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No Users Found</h4>
                    <p class="text-muted">Start by adding your first user account.</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createUserModal">
                        <i class="fas fa-plus-circle"></i> Add First User
                    </button>
                </div>
            </div>
            <div class="tab-pane fade" id="auditPane" role="tabpanel">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-list me-2"></i>Audit Log Entries</h6>
                        <span class="text-muted" id="logCount">Loading...</span>
                    </div>
                    <div class="card-body">
                        <div id="logsContainer">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin me-2"></i>Loading audit logs...
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-center mt-4">
                    <nav id="paginationContainer"></nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-plus"></i> Create New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="createUserForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="createEmail" class="form-label">Email Address <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="createEmail" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="createFullName" class="form-label">Full Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="createFullName" name="full_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="createRole" class="form-label">Role <span class="text-danger">*</span></label>
                            <select class="form-select" id="createRole" name="role" required>
                                <option value="">Select Role</option>
                                <option value="tutor">Tutor</option>
                                <option value="lead_tutor">Lead Tutor</option>
                                <option value="manager">Manager</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="createPassword" class="form-label">Password <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="createPassword" name="password" required>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="createActive" name="active" checked>
                            <label class="form-check-label" for="createActive">
                                Active Account
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Create User
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-edit"></i> Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editUserForm">
                    <input type="hidden" id="editUserId" name="user_id">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editEmail" class="form-label">Email Address <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="editEmail" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="editFullName" class="form-label">Full Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editFullName" name="full_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="editRole" class="form-label">Role <span class="text-danger">*</span></label>
                            <select class="form-select" id="editRole" name="role" required>
                                <option value="tutor">Tutor</option>
                                <option value="lead_tutor">Lead Tutor</option>
                                <option value="manager">Manager</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editPassword" class="form-label">Password <span class="text-muted">(leave blank to keep unchanged)</span></label>
                            <input type="password" class="form-control" id="editPassword" name="password" autocomplete="new-password">
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editActive" name="active">
                            <label class="form-check-label" for="editActive">
                                Active Account
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Update User
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger"><i class="fas fa-exclamation-triangle"></i> Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the user <strong id="deleteUserName">Unknown</strong>?</p>
                    <p class="text-muted small">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form id="deleteUserForm" style="display: inline;">
                        <input type="hidden" id="deleteUserId" name="user_id">
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Delete User
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let users = [];
        let logs = [];
        let currentPage = 1;
        let pageSize = 25;
        let totalPages = 1;
        let totalLogs = 0;

        // Load user data and set up UI
        async function loadUserData() {
            try {
                const response = await fetch('/api/user-info');
                if (response.ok) {
                    const userData = await response.json();
                    
                    // Update user display
                    document.getElementById('userDisplayName').textContent = userData.full_name || userData.email.split('@')[0];
                    document.getElementById('userEmail').textContent = userData.email;
                    
                    // Check if user has admin privileges
                    if (userData.role !== 'admin' && userData.role !== 'manager') {
                        window.location.href = '/';
                        return;
                    }
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                window.location.href = '/';
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                if (response.ok) {
                    users = await response.json();
                    displayUsers();
                } else {
                    showFlashMessage('Error loading users', 'error');
                }
            } catch (error) {
                console.error('Error loading users:', error);
                showFlashMessage('Error loading users', 'error');
            }
        }

        function displayUsers() {
            const container = document.getElementById('usersGrid');
            const emptyState = document.getElementById('emptyState');
            
            if (!users || users.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            let html = '';
            users.forEach(user => {
                html += `
                    <div class="col-lg-4 col-md-6">
                        <div class="card user-card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h5 class="card-title mb-1">${user.full_name}</h5>
                                        <p class="text-muted mb-0">${user.email}</p>
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="editUser('${user.user_id}')">
                                                <i class="fas fa-edit"></i> Edit
                                            </a></li>
                                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteUser('${user.user_id}', '${user.full_name}')">
                                                <i class="fas fa-trash"></i> Delete
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <span class="badge role-${user.role} role-badge">
                                        ${user.role.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                                    </span>
                                    <span class="badge bg-${user.active ? 'success' : 'secondary'} ms-2">
                                        ${user.active ? 'Active' : 'Inactive'}
                                    </span>
                                </div>
                                
                                <div class="small text-muted">
                                    <div><i class="fas fa-calendar-plus me-1"></i> Created: ${user.created_at ? user.created_at.split('T')[0] : 'N/A'}</div>
                                    <div><i class="fas fa-clock me-1"></i> Last Login: ${user.last_login ? user.last_login.split('T')[0] : 'Never'}</div>
                                </div>
                                
                                <div class="mt-3">
                                    <select class="form-select form-select-sm" onchange="changeRole('${user.user_id}', this.value)">
                                        <option value="">Quick Role Change</option>
                                        <option value="tutor" ${user.role === 'tutor' ? 'selected' : ''}>Tutor</option>
                                        <option value="lead_tutor" ${user.role === 'lead_tutor' ? 'selected' : ''}>Lead Tutor</option>
                                        <option value="manager" ${user.role === 'manager' ? 'selected' : ''}>Manager</option>
                                        <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function showFlashMessage(message, type = 'info') {
            const container = document.getElementById('flashMessages');
            const alertClass = type === 'error' ? 'danger' : type;
            const icon = type === 'error' ? 'exclamation-triangle' : 'check-circle';
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${alertClass} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                <i class="fas fa-${icon} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            container.appendChild(alertDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function editUser(userId) {
            const user = users.find(u => u.user_id === userId);
            if (!user) return;
            document.getElementById('editUserId').value = user.user_id;
            document.getElementById('editEmail').value = user.email;
            document.getElementById('editFullName').value = user.full_name;
            document.getElementById('editRole').value = user.role;
            document.getElementById('editActive').checked = user.active;
            document.getElementById('editPassword').value = '';
            new bootstrap.Modal(document.getElementById('editUserModal')).show();
        }

        function deleteUser(userId, userName) {
            document.getElementById('deleteUserId').value = userId;
            document.getElementById('deleteUserName').textContent = userName;
            new bootstrap.Modal(document.getElementById('deleteUserModal')).show();
        }

        async function changeRole(userId, newRole) {
            if (!newRole) return;
            
            try {
                const response = await fetch('/api/admin/change-role', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        role: newRole
                    })
                });
                
                if (response.ok) {
                    showFlashMessage('Role updated successfully', 'success');
                    loadUsers(); // Reload users
                } else {
                    showFlashMessage('Error updating role', 'error');
                }
            } catch (error) {
                console.error('Error changing role:', error);
                showFlashMessage('Error updating role', 'error');
            }
        }

        // Form submissions
        document.getElementById('createUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            data.active = formData.get('active') === 'on';
            
            try {
                const response = await fetch('/api/admin/create-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showFlashMessage('User created successfully', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
                    e.target.reset();
                    loadUsers();
                } else {
                    const error = await response.json();
                    showFlashMessage(error.message || 'Error creating user', 'error');
                }
            } catch (error) {
                console.error('Error creating user:', error);
                showFlashMessage('Error creating user', 'error');
            }
        });

        document.getElementById('editUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            data.active = formData.get('active') === 'on';
            // Only include password if provided
            if (!data.password) delete data.password;
            try {
                const response = await fetch('/api/admin/edit-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    showFlashMessage('User updated successfully', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                    loadUsers();
                } else {
                    const error = await response.json();
                    showFlashMessage(error.message || 'Error updating user', 'error');
                }
            } catch (error) {
                console.error('Error updating user:', error);
                showFlashMessage('Error updating user', 'error');
            }
        });

        document.getElementById('deleteUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const userId = formData.get('user_id');
            
            try {
                const response = await fetch('/api/admin/delete-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_id: userId })
                });
                
                if (response.ok) {
                    showFlashMessage('User deleted successfully', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('deleteUserModal')).hide();
                    loadUsers();
                } else {
                    const error = await response.json();
                    showFlashMessage(error.message || 'Error deleting user', 'error');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showFlashMessage('Error deleting user', 'error');
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadUserData();
            loadUsers();
            document.getElementById('audit-tab').addEventListener('shown.bs.tab', function () {
                loadAuditLogs();
            });
        });

        // --- Audit Log Tab Logic ---
        async function loadAuditLogs(page = 1) {
            currentPage = page;
            document.getElementById('logsContainer').innerHTML = '<div class="text-center text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Loading audit logs...</div>';
            try {
                const response = await fetch(`/api/admin/audit-logs?page=${page}&per_page=${pageSize}`);
                if (response.ok) {
                    const data = await response.json();
                    logs = data.logs || data || [];
                    totalLogs = data.total || logs.length;
                    totalPages = Math.ceil(totalLogs / pageSize) || 1;
                    renderAuditLogs();
                    renderPagination();
                } else {
                    document.getElementById('logsContainer').innerHTML = '<div class="text-danger">Failed to load audit logs.</div>';
                }
            } catch (e) {
                document.getElementById('logsContainer').innerHTML = '<div class="text-danger">Error loading audit logs.</div>';
            }
        }
        function renderAuditLogs() {
            if (!logs || logs.length === 0) {
                document.getElementById('logsContainer').innerHTML = '<div class="text-muted">No audit logs found.</div>';
                document.getElementById('logCount').textContent = '0 logs';
                return;
            }
            let html = `<table class="table table-sm table-bordered table-striped"><thead><tr><th>Time</th><th>Admin</th><th>Action</th><th>Target</th><th>Details</th><th>IP</th></tr></thead><tbody>`;
            logs.forEach(log => {
                // Fallback for admin_email and target_user_email
                const adminEmail = log.admin_email || log.user_email || '';
                const targetEmail = log.target_user_email || '';
                html += `<tr><td>${log.timestamp || ''}</td><td>${adminEmail}</td><td>${log.action || ''}</td><td>${targetEmail}</td><td>${log.details || ''}</td><td>${log.ip_address || ''}</td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('logsContainer').innerHTML = html;
            document.getElementById('logCount').textContent = `${totalLogs} logs`;
        }
        function renderPagination() {
            let html = '';
            if (totalPages > 1) {
                html += '<ul class="pagination">';
                for (let i = 1; i <= totalPages; i++) {
                    html += `<li class="page-item${i === currentPage ? ' active' : ''}"><a class="page-link" href="#" onclick="loadAuditLogs(${i});return false;">${i}</a></li>`;
                }
                html += '</ul>';
            }
            document.getElementById('paginationContainer').innerHTML = html;
        }
    </script>
</body>
</html>