<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>📋 Tutor Check-In Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/static/js/theme-switcher.js"></script>
  <script src="/static/js/error_handler.js"></script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
<script src="/static/js/admin_navbar_tailwind.js"></script>
<script src="/static/js/forecasting.js"></script>
<div class="max-w-7xl mx-auto px-4 py-8">
  <div class="text-center mb-8">
    <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white mb-2 tracking-tight drop-shadow">📋 Tutor Check-In Dashboard</h2>
    <p class="text-lg text-gray-600 dark:text-gray-300 font-medium mb-6">Browse tutor check-ins grouped by date</p>
    <div class="flex flex-wrap justify-center gap-4 my-8">
      <a href="/charts" class="inline-flex items-center px-5 py-2 border border-blue-600 text-blue-600 dark:text-blue-400 dark:border-blue-400 rounded-lg font-semibold hover:bg-blue-50 dark:hover:bg-blue-900 focus:outline-none focus:ring-2 focus:ring-blue-400 transition"><i class="fas fa-chart-line mr-2"></i>View Charts</a>
      <button class="inline-flex items-center px-5 py-2 border border-gray-400 text-gray-700 dark:text-gray-200 dark:border-gray-600 rounded-lg font-semibold hover:bg-gray-100 dark:hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-400 transition" id="toggleAllCollapsibleBtn" data-state="collapsed"><i class="fas fa-expand-arrows-alt mr-2"></i>Expand/Collapse Logs</button>
      <a href="/download-log" class="inline-flex items-center px-5 py-2 border border-green-600 text-green-600 dark:text-green-400 dark:border-green-400 rounded-lg font-semibold hover:bg-green-50 dark:hover:bg-green-900 focus:outline-none focus:ring-2 focus:ring-green-400 transition"><i class="fas fa-file-csv mr-2"></i>Download Full CSV</a>
      <button class="inline-flex items-center px-5 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400 transition" data-bs-toggle="modal" data-bs-target="#manualCheckinModal"><i class="fas fa-plus-circle mr-2"></i>Manual Check-In</button>
    </div>
  </div>

  <!-- Enhanced KPI Dashboard -->
  <div class="mb-8">
    <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4">
      <h5 class="text-lg font-semibold flex items-center gap-2 text-gray-800 dark:text-gray-200"><i class="fas fa-tachometer-alt"></i>Key Performance Indicators</h5>
      <small class="text-gray-500 dark:text-gray-400">Real-time dashboard metrics</small>
    </div>
    <!-- Primary KPI Row -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6" id="primaryKPIs">
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col items-center border border-gray-200 dark:border-gray-700 hover:shadow-xl transition-shadow duration-300" style="animation-delay: 0.1s;">
        <div class="bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 rounded-full p-3 mb-3"><i class="fas fa-check-circle fa-lg"></i></div>
        <div class="text-3xl font-bold text-gray-800 dark:text-gray-200" id="totalCheckins">-</div>
        <div class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Total Check-ins</div>
        <div class="text-green-600 dark:text-green-400 text-sm mt-1" id="checkinsTrend">+12% vs last month</div>
      </div>
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col items-center border border-gray-200 dark:border-gray-700 hover:shadow-xl transition-shadow duration-300" style="animation-delay: 0.2s;">
        <div class="bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-300 rounded-full p-3 mb-3"><i class="fas fa-clock fa-lg"></i></div>
        <div class="text-3xl font-bold text-gray-800 dark:text-gray-200" id="totalHours">-</div>
        <div class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Total Hours</div>
        <div class="text-green-600 dark:text-green-400 text-sm mt-1" id="hoursTrend">+8% vs last month</div>
      </div>
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col items-center border border-gray-200 dark:border-gray-700 hover:shadow-xl transition-shadow duration-300" style="animation-delay: 0.3s;">
        <div class="bg-cyan-100 dark:bg-cyan-900 text-cyan-600 dark:text-cyan-300 rounded-full p-3 mb-3"><i class="fas fa-users fa-lg"></i></div>
        <div class="text-3xl font-bold text-gray-800 dark:text-gray-200" id="activeTutors">-</div>
        <div class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Active Tutors</div>
        <div class="text-green-600 dark:text-green-400 text-sm mt-1" id="tutorsTrend">+5% vs last month</div>
      </div>
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 flex flex-col items-center border border-gray-200 dark:border-gray-700 hover:shadow-xl transition-shadow duration-300" style="animation-delay: 0.4s;">
        <div class="bg-yellow-100 dark:bg-yellow-900 text-yellow-600 dark:text-yellow-300 rounded-full p-3 mb-3"><i class="fas fa-hourglass-half fa-lg"></i></div>
        <div class="text-3xl font-bold text-gray-800 dark:text-gray-200" id="avgSessionDuration">-</div>
        <div class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Avg Session</div>
        <div class="text-red-600 dark:text-red-400 text-sm mt-1" id="sessionTrend">-3% vs last month</div>
      </div>
    </div>
    
    <!-- Secondary KPI Row -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-4" id="secondaryKPIs">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-shadow duration-300" style="animation-delay: 0.5s;">
        <div class="flex items-center justify-center w-10 h-10 bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 rounded-full mb-3">
          <i class="fas fa-calendar-day text-lg"></i>
        </div>
        <div class="text-2xl font-bold text-gray-800 dark:text-gray-200 text-center" id="avgDailyHours">-</div>
        <div class="text-xs text-gray-500 dark:text-gray-400 text-center uppercase tracking-wide">Daily Avg Hours</div>
      </div>
      
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-shadow duration-300" style="animation-delay: 0.6s;">
        <div class="flex items-center justify-center w-10 h-10 bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-300 rounded-full mb-3">
          <i class="fas fa-chart-line text-lg"></i>
        </div>
        <div class="text-2xl font-bold text-gray-800 dark:text-gray-200 text-center" id="peakCheckinHour">-</div>
        <div class="text-xs text-gray-500 dark:text-gray-400 text-center uppercase tracking-wide">Peak Hour</div>
      </div>
      
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-shadow duration-300" style="animation-delay: 0.7s;">
        <div class="flex items-center justify-center w-10 h-10 bg-purple-100 dark:bg-purple-900 text-purple-600 dark:text-purple-300 rounded-full mb-3">
          <i class="fas fa-star text-lg"></i>
        </div>
        <div class="text-2xl font-bold text-gray-800 dark:text-gray-200 text-center" id="topDay">-</div>
        <div class="text-xs text-gray-500 dark:text-gray-400 text-center uppercase tracking-wide">Most Active Day</div>
      </div>
      
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-shadow duration-300" style="animation-delay: 0.8s;">
        <div class="flex items-center justify-center w-10 h-10 bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-300 rounded-full mb-3">
          <i class="fas fa-percentage text-lg"></i>
        </div>
        <div class="text-2xl font-bold text-gray-800 dark:text-gray-200 text-center" id="attendanceRate">-</div>
        <div class="text-xs text-gray-500 dark:text-gray-400 text-center uppercase tracking-wide">Attendance Rate</div>
      </div>
      
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-shadow duration-300" style="animation-delay: 0.9s;">
        <div class="flex items-center justify-center w-10 h-10 bg-pink-100 dark:bg-pink-900 text-pink-600 dark:text-pink-300 rounded-full mb-3">
          <i class="fas fa-user-graduate text-lg"></i>
        </div>
        <div class="text-2xl font-bold text-gray-800 dark:text-gray-200 text-center" id="newTutors">-</div>
        <div class="text-xs text-gray-500 dark:text-gray-400 text-center uppercase tracking-wide">New This Month</div>
      </div>
      
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-shadow duration-300" style="animation-delay: 1.0s;">
        <div class="flex items-center justify-center w-10 h-10 bg-teal-100 dark:bg-teal-900 text-teal-600 dark:text-teal-300 rounded-full mb-3">
          <i class="fas fa-medal text-lg"></i>
        </div>
        <div class="text-2xl font-bold text-gray-800 dark:text-gray-200 text-center" id="consistency">-</div>
        <div class="text-xs text-gray-500 dark:text-gray-400 text-center uppercase tracking-wide">Consistency Score</div>
      </div>
    </div>
    
    <!-- Top Performer Highlight -->
    <div class="w-full">
      <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl shadow-lg p-6 border border-blue-200 dark:border-blue-700" style="animation-delay: 1.1s;">
        <div class="flex flex-col md:flex-row md:justify-between md:items-center">
          <div class="flex items-center mb-4 md:mb-0">
            <div class="flex items-center justify-center w-12 h-12 bg-white bg-opacity-20 text-white rounded-full mr-4">
              <i class="fas fa-trophy text-xl"></i>
            </div>
            <div>
              <h6 class="text-white text-sm font-medium mb-1">🏆 Top Performer This Month</h6>
              <h4 class="text-white text-2xl font-bold" id="topTutorMonth">Loading...</h4>
            </div>
          </div>
          <div class="text-right">
            <small class="text-blue-100 text-xs">Based on total hours worked</small>
            <br>
            <span class="inline-block bg-white bg-opacity-20 text-white px-3 py-1 rounded-full text-sm font-medium mt-1" id="topTutorHours">- hours</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AI Forecasting & Insights Section -->
  <div class="mb-6">
    <div class="w-full">
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border border-gray-200 dark:border-gray-700">
        <h4 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4 flex items-center">
          <i class="fas fa-brain mr-3 text-blue-600 dark:text-blue-400"></i>
          AI Forecasting & Insights 
          <span class="text-gray-500 dark:text-gray-400 text-sm font-normal ml-2">(powered by real data)</span>
        </h4>
      </div>
    </div>
  </div>
  <!-- Improved AI Forecasting Summary -->
  <div class="mb-4">
    <div class="w-full">
      <div class="bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-900 dark:to-orange-900 border border-yellow-200 dark:border-yellow-700 rounded-lg p-4 shadow-sm" id="improvedNLSummary">
        <div class="flex items-center">
          <i class="fas fa-lightbulb text-yellow-600 dark:text-yellow-400 mr-3 text-lg"></i>
          <span class="text-gray-800 dark:text-gray-200 font-medium">Loading AI forecast summary...</span>
          <i class="fas fa-info-circle ml-2 text-gray-500 dark:text-gray-400" data-bs-toggle="tooltip" title="AI-generated summary of key trends and predictions."></i>
        </div>
      </div>
    </div>
  </div>
  <!-- New AI Forecasting Features Row -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <!-- AI Confidence Score -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 border border-gray-200 dark:border-gray-700 hover:shadow-xl transition-shadow duration-300">
      <div class="text-center">
        <div class="flex items-center justify-center w-12 h-12 bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 rounded-full mx-auto mb-3">
          <i class="fas fa-robot text-lg"></i>
        </div>
        <h4 class="text-2xl font-bold text-gray-800 dark:text-gray-200" id="aiConfidenceScore">-</h4>
        <div class="text-sm text-gray-500 dark:text-gray-400 mt-2">
          AI Confidence Score 
          <i class="fas fa-info-circle ml-1" data-bs-toggle="tooltip" title="How confident the AI is in its predictions (higher is better)"></i>
        </div>
      </div>
    </div>
    <!-- Forecast Accuracy -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 border border-gray-200 dark:border-gray-700 hover:shadow-xl transition-shadow duration-300">
      <div class="text-center">
        <div class="flex items-center justify-center w-12 h-12 bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-300 rounded-full mx-auto mb-3">
          <i class="fas fa-bullseye text-lg"></i>
        </div>
        <h4 class="text-2xl font-bold text-gray-800 dark:text-gray-200" id="forecastAccuracy">-</h4>
        <div class="text-sm text-gray-500 dark:text-gray-400 mt-2">
          Forecast Accuracy 
          <i class="fas fa-info-circle ml-1" data-bs-toggle="tooltip" title="How close last week's forecast was to reality"></i>
        </div>
      </div>
    </div>
    <!-- Top Growth Opportunities -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 border border-gray-200 dark:border-gray-700 hover:shadow-xl transition-shadow duration-300">
      <div class="text-center">
        <div class="flex items-center justify-center w-12 h-12 bg-yellow-100 dark:bg-yellow-900 text-yellow-600 dark:text-yellow-300 rounded-full mx-auto mb-3">
          <i class="fas fa-arrow-up text-lg"></i>
        </div>
        <div class="text-sm text-gray-500 dark:text-gray-400 mb-3">
          Top Growth Opportunities 
          <i class="fas fa-info-circle ml-1" data-bs-toggle="tooltip" title="Where the most growth is expected"></i>
        </div>
        <ul class="text-sm text-gray-700 dark:text-gray-300 text-left space-y-1" id="topGrowthOpportunities"></ul>
      </div>
    </div>
    <!-- Scenario Simulation -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 border border-gray-200 dark:border-gray-700 hover:shadow-xl transition-shadow duration-300">
      <div class="text-center">
        <div class="flex items-center justify-center w-12 h-12 bg-cyan-100 dark:bg-cyan-900 text-cyan-600 dark:text-cyan-300 rounded-full mx-auto mb-3">
          <i class="fas fa-users-cog text-lg"></i>
        </div>
        <div class="text-sm text-gray-500 dark:text-gray-400 mb-3">
          Scenario Simulation 
          <i class="fas fa-info-circle ml-1" data-bs-toggle="tooltip" title="Impact of adding more tutors"></i>
        </div>
        <div class="text-sm text-gray-700 dark:text-gray-300 text-left space-y-1" id="scenarioSimulationTable">
          <div class="flex justify-between"><span>+2 tutors</span><span id="simTutors2">-</span></div>
          <div class="flex justify-between"><span>+5 tutors</span><span id="simTutors5">-</span></div>
          <div class="flex justify-between"><span>+10 tutors</span><span id="simTutors10">-</span></div>
        </div>
      </div>
    </div>
  </div>
  <!-- Hourly Forecast Bar Chart/Table -->
  <div class="mb-6">
    <div class="w-full">
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center">
          <i class="fas fa-clock mr-3 text-blue-600 dark:text-blue-400"></i>
          <span class="text-lg font-semibold text-gray-800 dark:text-gray-200">Hourly Forecast</span>
          <i class="fas fa-info-circle ml-2 text-gray-500 dark:text-gray-400" data-bs-toggle="tooltip" title="Predicted hours and sessions for each hour of the day"></i>
        </div>
        <div class="p-6">
          <div id="hourlyForecastTable" class="overflow-x-auto"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Alerts Section -->
<div id="alertsContainer" class="mb-4">
  <!-- Alerts will be populated here by JavaScript -->
</div>

<!-- Forecasting & Trends Section -->
<div class="mb-6">
  <div class="w-full">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
      <div class="p-4 border-b border-gray-200 dark:border-gray-700">
        <h5 class="text-lg font-semibold text-gray-800 dark:text-gray-200 flex items-center">
          <i class="fas fa-chart-line mr-3 text-blue-600 dark:text-blue-400"></i> 
          Forecasting & Trends
        </h5>
      </div>
      <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <!-- Next Week Prediction Card -->
          <div class="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900 dark:to-indigo-900 rounded-lg p-4 border border-blue-200 dark:border-blue-700">
            <div class="text-center">
              <i class="fas fa-calendar-alt text-blue-600 dark:text-blue-400 text-2xl mb-3"></i>
              <h4 class="text-2xl font-bold text-gray-800 dark:text-gray-200" id="nextWeekHours">-</h4>
              <h6 class="text-gray-600 dark:text-gray-300 mb-2">Expected Hours Next Week</h6>
              <span class="inline-block bg-blue-600 text-white px-2 py-1 rounded text-xs mb-1" id="nextWeekConfidence">-</span>
              <span class="inline-block bg-green-600 text-white px-2 py-1 rounded text-xs mb-1 ml-1" id="nextWeekTrend">-</span>
              <div class="text-xs text-gray-500 dark:text-gray-400 mt-2" id="nextWeekCI">-</div>
              <div class="text-xs text-gray-500 dark:text-gray-400" id="nextWeekMethods">-</div>
            </div>
          </div>
          <!-- Next Month Prediction Card -->
          <div class="bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900 dark:to-emerald-900 rounded-lg p-4 border border-green-200 dark:border-green-700">
            <div class="text-center">
              <i class="fas fa-calendar text-green-600 dark:text-green-400 text-2xl mb-3"></i>
              <h4 class="text-2xl font-bold text-gray-800 dark:text-gray-200" id="nextMonthHours">-</h4>
              <h6 class="text-gray-600 dark:text-gray-300 mb-2">Expected Hours Next Month</h6>
              <span class="inline-block bg-cyan-600 text-white px-2 py-1 rounded text-xs mb-1" id="nextMonthConfidence">-</span>
              <span class="inline-block bg-green-600 text-white px-2 py-1 rounded text-xs mb-1 ml-1" id="nextMonthTrend">-</span>
              <div class="text-xs text-gray-500 dark:text-gray-400 mt-2" id="nextMonthCI">-</div>
            </div>
          </div>
          <!-- Tutor Demand Forecast Card -->
          <div class="bg-gradient-to-br from-purple-50 to-pink-50 dark:from-purple-900 dark:to-pink-900 rounded-lg p-4 border border-purple-200 dark:border-purple-700">
            <div class="text-center">
              <i class="fas fa-users text-purple-600 dark:text-purple-400 text-2xl mb-3"></i>
              <h4 class="text-2xl font-bold text-gray-800 dark:text-gray-200" id="tutorDemandWeek">-</h4>
              <h6 class="text-gray-600 dark:text-gray-300 mb-2">Expected Tutors Next Week</h6>
              <div class="text-xs text-gray-500 dark:text-gray-400 mt-2" id="tutorDemandMonth">-</div>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- Seasonal Pattern Card -->
          <div class="bg-gradient-to-br from-yellow-50 to-orange-50 dark:from-yellow-900 dark:to-orange-900 rounded-lg p-4 border border-yellow-200 dark:border-yellow-700">
            <div class="text-center">
              <i class="fas fa-sun text-yellow-600 dark:text-yellow-400 text-2xl mb-3"></i>
              <h4 class="text-2xl font-bold text-gray-800 dark:text-gray-200" id="busiestDay">-</h4>
              <h6 class="text-gray-600 dark:text-gray-300 mb-2">Busiest Day & Hour</h6>
              <div class="text-xs text-gray-500 dark:text-gray-400 mt-2" id="busiestHour">-</div>
            </div>
          </div>
          <!-- Anomaly Detection Card -->
          <div class="bg-gradient-to-br from-red-50 to-pink-50 dark:from-red-900 dark:to-pink-900 rounded-lg p-4 border border-red-200 dark:border-red-700">
            <div class="text-center">
              <i class="fas fa-exclamation-triangle text-red-600 dark:text-red-400 text-2xl mb-3"></i>
              <h4 class="text-2xl font-bold text-gray-800 dark:text-gray-200" id="anomalyStatus">-</h4>
              <h6 class="text-gray-600 dark:text-gray-300 mb-2">Anomaly Detection</h6>
              <div class="text-xs text-gray-500 dark:text-gray-400 mt-2" id="anomalyPercent">-</div>
              <div class="text-xs text-gray-500 dark:text-gray-400" id="anomalyLastWeek">-</div>
              <div class="text-xs text-gray-500 dark:text-gray-400" id="anomalyPrevAvg">-</div>
            </div>
          </div>
          <!-- Historical vs Forecast Card -->
          <div class="bg-gradient-to-br from-gray-50 to-slate-50 dark:from-gray-900 dark:to-slate-900 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
            <div class="text-center">
              <i class="fas fa-history text-gray-600 dark:text-gray-400 text-2xl mb-3"></i>
              <h4 class="text-2xl font-bold text-gray-800 dark:text-gray-200" id="histLastWeek">-</h4>
              <h6 class="text-gray-600 dark:text-gray-300 mb-2">Last Week vs Forecast</h6>
              <div class="text-xs text-gray-500 dark:text-gray-400 mt-2" id="histForecastWeek">-</div>
              <div class="text-xs text-gray-500 dark:text-gray-400" id="histLastMonth">-</div>
              <div class="text-xs text-gray-500 dark:text-gray-400" id="histForecastMonth">-</div>
            </div>
          </div>
        </div>
        <div class="text-right mt-4">
          <small class="text-gray-500 dark:text-gray-400">Last updated: <span id="forecastLastUpdated">-</span></small>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Upcoming Shifts Section -->
<div class="mb-6">
  <div class="w-full">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
      <div class="p-4 border-b border-gray-200 dark:border-gray-700">
        <h5 class="text-lg font-semibold text-gray-800 dark:text-gray-200 flex items-center">
          <i class="fas fa-calendar-alt mr-3 text-blue-600 dark:text-blue-400"></i> 
          Upcoming Shifts
        </h5>
      </div>
      <div class="p-6">
        <div id="upcomingShiftsContainer"></div>
      </div>
    </div>
  </div>
</div>

<hr class="my-6 border-gray-300 dark:border-gray-600">
<div class="mb-6">
  <h4 class="text-2xl font-bold text-gray-800 dark:text-gray-200 text-center mb-4">Grouped Log Entries</h4>
  <div id="logContainerCollapsible" class="space-y-4">
    <!-- Original collapsible log view (all logs) will be populated here -->
  </div>
</div>
</div>

<!-- Manual Check-In Modal -->
<div class="modal fade" id="manualCheckinModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="post" action="/check-in" class="modal-content">
      <div class="modal-header"><h5 class="modal-title"><i class="fas fa-edit"></i> Manual Check-In</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="mb-2"><label for="tutor_id_modal" class="form-label">Tutor ID <span class="text-danger">*</span></label><input type="text" name="tutor_id" id="tutor_id_modal" class="form-control" required></div>
        <div class="mb-2"><label for="tutor_name_modal" class="form-label">Tutor Name</label><input type="text" name="tutor_name" id="tutor_name_modal" class="form-control"></div>
        <div class="mb-2"><label for="check_in_modal" class="form-label">Check-In <span class="text-danger">*</span></label><input type="datetime-local" name="check_in" id="check_in_modal" class="form-control" required></div>
        <div class="mb-2"><label for="check_out_modal" class="form-label">Check-Out</label><input type="datetime-local" name="check_out" id="check_out_modal" class="form-control"></div>
        <div class="mb-2"><label for="shift_hours_modal" class="form-label">Shift Hours</label><input type="number" step="0.01" name="shift_hours" id="shift_hours_modal" class="form-control"></div>
        <div class="mb-2"><label for="snapshot_in_modal" class="form-label">Snapshot In Path</label><input type="text" name="snapshot_in" id="snapshot_in_modal" class="form-control" placeholder="snapshots/tutor_id_in.jpg"></div>
        <div class="mb-2"><label for="snapshot_out_modal" class="form-label">Snapshot Out Path</label><input type="text" name="snapshot_out" id="snapshot_out_modal" class="form-control" placeholder="snapshots/tutor_id_out.jpg"></div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="submit" class="btn btn-primary"><i class="fas fa-check"></i> Submit</button></div>
    </form>
  </div>
</div>

<!-- Snapshot Modal -->
<div class="modal fade" id="snapshotModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark">
        <div class="modal-header border-0"><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div>
      <div class="modal-body text-center p-0"><img id="modalImage" class="img-fluid rounded" src="" alt="Snapshot" style="max-height: 80vh;" /></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  function toggleTheme() {
    const html = document.documentElement;
    const isDark = html.classList.toggle("dark-mode");
    document.body.classList.toggle("dark-mode");
    document.getElementById("themeToggleBtn").innerHTML = isDark ? '<i class="fas fa-sun"></i> Light Mode' : '<i class="fas fa-moon"></i> Dark Mode';
    localStorage.setItem("darkMode", isDark ? "enabled" : "disabled");
    document.querySelectorAll('.table').forEach(table => isDark ? table.classList.add('table-dark') : table.classList.remove('table-dark'));
  }

  function showSnapshotModal(src) {
    const modalImage = document.getElementById("modalImage");
    let imageSrc = src;
    if (!src.startsWith('http') && !src.startsWith('/static/')) {
        imageSrc = `/static/${src}`; 
    } else if (src.startsWith('static/')) { 
        imageSrc = `/${src}`;
    }
    modalImage.src = imageSrc;
    modalImage.onerror = function() { 
        modalImage.alt = "Image not found";
        modalImage.src = "data:image/svg+xml;charset=UTF8,%3Csvg%20width%3D%22100%22%20height%3D%22100%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Crect%20width%3D%22100%22%20height%3D%22100%22%20fill%3D%22%23ddd%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20text-anchor%3D%22middle%22%20dy%3D%22.3em%22%20font-size%3D%2212%22%20fill%3D%22%23777%22%3EError%3C%2Ftext%3E%3C%2Fsvg%3E";
    };
    new bootstrap.Modal(document.getElementById("snapshotModal")).show();
  }

  async function loadDashboardSummaryAndCollapsibleLogs() {
    console.log('loadDashboardSummaryAndCollapsibleLogs called');
    // Show loading state for KPIs
    showKPILoadingState();
    document.getElementById("logContainerCollapsible").innerHTML = '<div class="col-12 text-center p-3"><div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Loading...</span></div> <p>Loading logs...</p></div>';

    try {
        console.log('Fetching dashboard data...');
        const res = await fetch('/dashboard-data');
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}. Failed to load dashboard data.`);
        const data = await res.json();
        console.log('Dashboard data received');
        
        // Update all KPI values
        updateKPIValues(data.summary);
        
        displayAlerts(data.alerts);
        populateCollapsibleLogs(data.logs_for_collapsible_view || []);
        
        // Load upcoming shifts
        console.log('Calling loadUpcomingShifts...');
            await loadUpcomingShifts();

    // Load forecasting data
    console.log('Loading forecasting data...');
    await loadForecastingData();

    // Load AI insights
    console.log('Loading AI insights...');
    await loadAIInsights();

    } catch (error) {
        console.error("Error loading dashboard summary:", error);
        showKPIErrorState(error.message);
        document.getElementById("logContainerCollapsible").innerHTML = `<div class="alert alert-warning col-12">Could not load logs.</div>`;
    }
  }

  function showKPILoadingState() {
    const kpiElements = [
      'totalCheckins', 'totalHours', 'activeTutors', 'avgSessionDuration',
      'avgDailyHours', 'peakCheckinHour', 'topDay', 'attendanceRate',
      'newTutors', 'consistency', 'topTutorMonth', 'topTutorHours'
    ];
    
    kpiElements.forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';
      }
    });
  }

  function showKPIErrorState(message) {
    const kpiElements = [
      'totalCheckins', 'totalHours', 'activeTutors', 'avgSessionDuration',
      'avgDailyHours', 'peakCheckinHour', 'topDay', 'attendanceRate',
      'newTutors', 'consistency', 'topTutorMonth', 'topTutorHours'
    ];
    
    kpiElements.forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.textContent = 'Error';
      }
    });
  }

  function updateKPIValues(summary) {
    // Primary KPIs
    document.getElementById("totalCheckins").textContent = summary.total_checkins.toLocaleString();
    document.getElementById("totalHours").textContent = summary.total_hours + 'h';
    document.getElementById("activeTutors").textContent = summary.active_tutors;
    document.getElementById("avgSessionDuration").textContent = (summary.avg_session_duration !== '—' ? summary.avg_session_duration + 'h' : '—');
    
    // Secondary KPIs
    document.getElementById("avgDailyHours").textContent = (summary.avg_daily_hours !== '—' ? summary.avg_daily_hours + 'h' : '—');
    document.getElementById("peakCheckinHour").textContent = summary.peak_checkin_hour || '—';
    document.getElementById("topDay").textContent = summary.top_day || '—';
    
    // Calculate additional KPIs
    const attendanceRate = calculateAttendanceRate(summary);
    const newTutors = calculateNewTutors(summary);
    const consistency = calculateConsistencyScore(summary);
    const topTutorHours = calculateTopTutorHours(summary);
    
    document.getElementById("attendanceRate").textContent = attendanceRate + '%';
    document.getElementById("newTutors").textContent = newTutors;
    document.getElementById("consistency").textContent = consistency + '%';
    document.getElementById("topTutorMonth").textContent = summary.top_tutor_current_month || '—';
    document.getElementById("topTutorHours").textContent = topTutorHours + ' hours';
  }

  function calculateAttendanceRate(summary) {
    // Mock calculation - in real implementation, this would be based on expected vs actual attendance
    const baseRate = 85;
    const variance = Math.floor(Math.random() * 20) - 10; // ±10%
    return Math.max(0, Math.min(100, baseRate + variance));
  }

  function calculateNewTutors(summary) {
    // Mock calculation - in real implementation, this would count tutors who started this month
    return Math.floor(summary.active_tutors * 0.15); // Assume 15% are new
  }

  function calculateConsistencyScore(summary) {
    // Mock calculation - in real implementation, this would measure schedule adherence
    const baseScore = 78;
    const variance = Math.floor(Math.random() * 30) - 15; // ±15%
    return Math.max(0, Math.min(100, baseScore + variance));
  }

  function calculateTopTutorHours(summary) {
    // Mock calculation - in real implementation, this would be the actual top tutor's hours
    const avgHours = parseFloat(summary.total_hours) / summary.active_tutors;
    return Math.floor(avgHours * 1.5); // Assume top tutor works 50% more than average
  }

  function displayAlerts(alerts) {
    const container = document.getElementById('alertsContainer');
    container.innerHTML = '';
    
    if (!alerts || alerts.length === 0) {
      return;
    }
    
    alerts.forEach(alert => {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${alert.type} alert-dismissible fade show`;
      alertDiv.innerHTML = `
        <div class="d-flex align-items-center">
          <i class="fas fa-${getAlertIcon(alert.type)} me-2"></i>
          <div>
            <strong>${alert.title}</strong><br>
            <small>${alert.message}</small>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      container.appendChild(alertDiv);
    });
  }
  
  function getAlertIcon(type) {
    switch(type) {
      case 'danger': return 'exclamation-triangle';
      case 'warning': return 'exclamation-circle';
      case 'info': return 'info-circle';
      case 'success': return 'check-circle';
      default: return 'bell';
    }
  }
  
  async function loadUpcomingShifts(page = 1) {
    console.log('loadUpcomingShifts called for page:', page);
    try {
      console.log('Fetching /upcoming-shifts...');
      const response = await fetch(`/upcoming-shifts?page=${page}&per_page=12&exclude_today=true`);
      console.log('Response status:', response.status);
      if (response.ok) {
        const data = await response.json();
        console.log('Shifts received:', data.shifts ? data.shifts.length : 0, 'shifts');
        console.log('Pagination info:', data.pagination);
        displayUpcomingShifts(data.shifts, data.pagination);
      } else {
        console.log('Response not ok, status:', response.status);
        document.getElementById('upcomingShiftsContainer').innerHTML = 
          '<div class="text-center text-muted">No upcoming shifts found.</div>';
      }
    } catch (error) {
      console.error('Error loading upcoming shifts:', error);
      document.getElementById('upcomingShiftsContainer').innerHTML = 
        '<div class="text-center text-muted">Error loading shifts.</div>';
    }
  }
  
  function displayUpcomingShifts(shifts, pagination) {
    console.log('displayUpcomingShifts called with:', shifts);
    const container = document.getElementById('upcomingShiftsContainer');
    console.log('Container found:', container);
    
    if (!shifts || shifts.length === 0) {
      console.log('No shifts to display');
      container.innerHTML = '<div class="text-center text-muted">No upcoming shifts scheduled.</div>';
      return;
    }
    
    console.log('Displaying', shifts.length, 'shifts');
    
    // Display shifts
    let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
    shifts.forEach((shift, index) => {
      console.log('Processing shift', index, ':', shift);
      
      html += `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-blue-200 dark:border-blue-700 hover:shadow-xl transition-shadow duration-300">
          <div class="p-4">
            <h6 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-3">${shift.shift_name || 'Shift ' + shift.shift_id}</h6>
            <div class="space-y-2 text-sm text-gray-600 dark:text-gray-300">
              <div><strong class="text-gray-700 dark:text-gray-200">Date:</strong> ${shift.date} (${shift.day_name})</div>
              <div><strong class="text-gray-700 dark:text-gray-200">Time:</strong> ${shift.start_time} - ${shift.end_time}</div>
              <div><strong class="text-gray-700 dark:text-gray-200">Tutor:</strong> ${shift.tutor_name || 'Unknown'}</div>
            </div>
          </div>
        </div>
      `;
    });
    html += '</div>';
    
    // Add pagination controls
    if (pagination && pagination.total_pages > 1) {
      html += `
        <div class="flex flex-col sm:flex-row justify-between items-center mt-6 space-y-4 sm:space-y-0">
          <div class="text-gray-500 dark:text-gray-400 text-sm">
            Showing ${((pagination.current_page - 1) * pagination.per_page) + 1} to ${Math.min(pagination.current_page * pagination.per_page, pagination.total_shifts)} of ${pagination.total_shifts} shifts
          </div>
          <nav aria-label="Upcoming shifts pagination">
            <ul class="flex space-x-1">
              <li>
                <button class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-l-md hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-400 dark:hover:bg-gray-700 ${pagination.has_prev ? '' : 'opacity-50 cursor-not-allowed'}" onclick="loadUpcomingShifts(${pagination.current_page - 1})" ${pagination.has_prev ? '' : 'disabled'}>
                  <i class="fas fa-chevron-left mr-1"></i> Previous
                </button>
              </li>
      `;
      
      // Show page numbers
      const startPage = Math.max(1, pagination.current_page - 2);
      const endPage = Math.min(pagination.total_pages, pagination.current_page + 2);
      
      for (let i = startPage; i <= endPage; i++) {
        html += `
          <li>
            <button class="px-3 py-2 text-sm font-medium ${i === pagination.current_page ? 'text-blue-600 bg-blue-50 border border-blue-300 dark:bg-blue-900 dark:border-blue-700 dark:text-blue-400' : 'text-gray-500 bg-white border border-gray-300 hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-400 dark:hover:bg-gray-700'}" onclick="loadUpcomingShifts(${i})">${i}</button>
          </li>
        `;
      }
      
      html += `
              <li>
                <button class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-r-md hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-400 dark:hover:bg-gray-700 ${pagination.has_next ? '' : 'opacity-50 cursor-not-allowed'}" onclick="loadUpcomingShifts(${pagination.current_page + 1})" ${pagination.has_next ? '' : 'disabled'}>
                  Next <i class="fas fa-chevron-right ml-1"></i>
                </button>
              </li>
            </ul>
          </nav>
        </div>
      `;
    }
    
    console.log('Setting container HTML');
    container.innerHTML = html;
    console.log('Upcoming shifts displayed successfully');
  }

  function groupLogsByMonthAndDate(logs) { 
    const grouped = {};
    (logs || []).forEach(log => {
      // Ensure check_in is valid before creating Date object
      if (!log.check_in || isNaN(new Date(log.check_in).getTime())) {
          console.warn("Invalid check_in date found in log:", log);
          return; // Skip this log entry
      }
      const dateObj = new Date(log.check_in);
      const monthStr = dateObj.toLocaleString("default", { month: "long", year: "numeric" });
      const dateStr = dateObj.toLocaleDateString("default", { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      if (!grouped[monthStr]) grouped[monthStr] = {};
      if (!grouped[monthStr][dateStr]) grouped[monthStr][dateStr] = [];
      grouped[monthStr][dateStr].push(log);
    });
    return grouped;
  }
  function monthNameToNumber(monthName) { return new Date(Date.parse(monthName +" 1, 2012")).getMonth(); }

  function populateCollapsibleLogs(logs) {
    const grouped = groupLogsByMonthAndDate(logs);
    const container = document.getElementById("logContainerCollapsible");
    container.innerHTML = '';
    const isDark = document.documentElement.classList.contains('dark');

    if (Object.keys(grouped).length === 0) {
        container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center p-6">No log entries to display.</p>';
        return;
    }

    Object.keys(grouped).sort((a,b) => new Date(b.split(" ")[1], monthNameToNumber(b.split(" ")[0]), 1) - new Date(a.split(" ")[1], monthNameToNumber(a.split(" ")[0]), 1)).forEach((month, i) => {
        const monthCard = document.createElement('div');
        monthCard.className = 'bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden';
        monthCard.innerHTML = `
            <div class="bg-gray-50 dark:bg-gray-700 p-4 cursor-pointer log-month-header hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors duration-200" data-bs-toggle="collapse" data-bs-target="#collapsible-month-${i}" aria-expanded="${i === 0 ? 'true' : 'false'}">
                <div class="flex justify-between items-center">
                    <strong class="text-gray-800 dark:text-gray-200">${month}</strong>
                    <span class="chevron-indicator text-gray-500 dark:text-gray-400">
                        <i class="fas fa-chevron-down transition-transform duration-200"></i>
                    </span>
                </div>
            </div>
            <div id="collapsible-month-${i}" class="collapse ${i === 0 ? 'show' : ''}">
                <div class="p-4 space-y-3" id="collapsible-month-body-${i}"></div>
            </div>`;
        container.appendChild(monthCard);
        const dateContainer = document.getElementById(`collapsible-month-body-${i}`);
        Object.keys(grouped[month]).sort((a,b) => new Date(b) - new Date(a)).forEach((date, j) => {
            const rows = grouped[month][date].map(entry => {
                // Check for valid dates before toLocaleString
                const checkInDate = entry.check_in && !isNaN(new Date(entry.check_in).getTime()) ? new Date(entry.check_in).toLocaleString() : 'Invalid Date';
                const checkOutDate = entry.check_out && !isNaN(new Date(entry.check_out).getTime()) ? new Date(entry.check_out).toLocaleString() : '—';
                return `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                        <td class="px-4 py-3 border-b border-gray-200 dark:border-gray-600">
                            <span class="inline-block bg-blue-600 text-white px-2 py-1 rounded text-sm">${entry.tutor_name || 'N/A'}</span>
                        </td>
                        <td class="px-4 py-3 border-b border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">${entry.tutor_id}</td>
                        <td class="px-4 py-3 border-b border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">${checkInDate}</td>
                        <td class="px-4 py-3 border-b border-gray-200 dark:border-gray-600">
                            ${entry.snapshot_in ? `<img src="/static/${entry.snapshot_in}" class="w-20 h-20 object-cover rounded cursor-pointer hover:opacity-80 transition-opacity" onclick="showSnapshotModal('${entry.snapshot_in}')" alt="In">` : '—'}
                        </td>
                        <td class="px-4 py-3 border-b border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">${checkOutDate}</td>
                        <td class="px-4 py-3 border-b border-gray-200 dark:border-gray-600">
                            ${entry.snapshot_out ? `<img src="/static/${entry.snapshot_out}" class="w-20 h-20 object-cover rounded cursor-pointer hover:opacity-80 transition-opacity" onclick="showSnapshotModal('${entry.snapshot_out}')" alt="Out">` : '—'}
                        </td>
                        <td class="px-4 py-3 border-b border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-300">${entry.shift_hours ? parseFloat(entry.shift_hours).toFixed(2) : '—'}</td>
                    </tr>`;
                }).join('');
            const dateCard = document.createElement('div');
            dateCard.className = 'bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 overflow-hidden';
            dateCard.innerHTML = `
            <div class="p-3 cursor-pointer log-date-header hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors duration-200" data-bs-toggle="collapse" data-bs-target="#collapsible-date-${i}-${j}">
                <div class="flex justify-between items-center">
                    <span class="text-gray-700 dark:text-gray-300 font-medium">${date}</span>
                    <span class="chevron-indicator text-gray-500 dark:text-gray-400">
                        <i class="fas fa-chevron-down transition-transform duration-200"></i>
                    </span>
                </div>
            </div>
            <div id="collapsible-date-${i}-${j}" class="collapse">
                <div class="p-4">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-100 dark:bg-gray-600">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Tutor</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">ID</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Check-In</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">In</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Check-Out</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Out</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Hours</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-600">
                                ${rows}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;
            dateContainer.appendChild(dateCard);
        });
    });
    addCollapseEventListeners();
  }
  
  document.addEventListener('DOMContentLoaded', () => {
    console.log('Main DOMContentLoaded event fired');
    
    // Theme is now handled by theme-switcher.js
    
    // Initialize dashboard data (only once)
    console.log('Initializing dashboard...');
    loadDashboardSummaryAndCollapsibleLogs();
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
      new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Set up event listeners
    document.getElementById('toggleAllCollapsibleBtn').addEventListener('click', () => {
      const btn = document.getElementById('toggleAllCollapsibleBtn');
      const expand = btn.dataset.state !== 'expanded';
      document.querySelectorAll('#logContainerCollapsible .collapse').forEach(el => {
        const instance = bootstrap.Collapse.getOrCreateInstance(el);
        expand ? instance.show() : instance.hide();
      });
      btn.dataset.state = expand ? 'expanded' : 'collapsed';
      btn.innerHTML = `<i class="fas ${expand ? 'fa-compress-arrows-alt' : 'fa-expand-arrows-alt'}"></i> ${expand ? 'Collapse All' : 'Expand All'} Logs`;
    });

    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    if(document.getElementById('check_in_modal')) { // Check if element exists
      document.getElementById('check_in_modal').value = now.toISOString().slice(0,16);
    }
    addCollapseEventListeners(); 
  });

  function addCollapseEventListeners() {
      document.querySelectorAll('.log-month-header, .log-date-header').forEach(header => {
          const targetId = header.getAttribute('data-bs-target');
          if (!targetId) return;
          const targetCollapse = document.querySelector(targetId);
          if (!targetCollapse) return;
          const chevron = header.querySelector('.chevron-indicator i');
          if(!chevron) return;
          
          // Remove old listeners to prevent multiple triggers if function is called again
          const newHeader = header.cloneNode(true);
          header.parentNode.replaceChild(newHeader, header);
          
          // Add new listeners to the cloned header
          const newChevron = newHeader.querySelector('.chevron-indicator i');
          targetCollapse.addEventListener('show.bs.collapse', () => {
              if(newChevron) {newChevron.classList.remove('fa-chevron-down'); newChevron.classList.add('fa-chevron-up');}
          });
          targetCollapse.addEventListener('hide.bs.collapse', () => {
              if(newChevron) {newChevron.classList.remove('fa-chevron-up'); newChevron.classList.add('fa-chevron-down');}
          });
           // Manually trigger chevron update for elements already shown (e.g. first month)
          if (targetCollapse.classList.contains('show') && newChevron) {
              newChevron.classList.remove('fa-chevron-down');
              newChevron.classList.add('fa-chevron-up');
          }

      });
  }

  async function loadDashboardAlerts() {
    try {
      const response = await fetch('/api/dashboard-alerts');
      if (response.ok) {
        const data = await response.json();
        const alerts = data.alerts || [];
        const container = document.getElementById('alertsContainer');
        if (!alerts.length) {
          container.innerHTML = '';
          return;
        }
        let html = '';
        alerts.forEach(alert => {
          html += `<div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i> ${alert}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>`;
        });
        container.innerHTML = html;
      }
    } catch (error) {
      console.error('Error loading dashboard alerts:', error);
    }
  }

  // Initialize tooltips (moved to main DOMContentLoaded)

  // Forecasting & Trends Functions
  async function loadForecastingData() {
    console.log('loadForecastingData called');
    try {
      console.log('Fetching /api/forecasting-data...');
      const response = await fetch('/api/forecasting-data');
      console.log('Response status:', response.status);
      if (response.ok) {
        const data = await response.json();
        console.log('Forecasting data received:', data);
        displayForecastingData(data);
      } else {
        console.error('Error loading forecasting data, status:', response.status);
        displayForecastingError();
      }
    } catch (error) {
      console.error('Error loading forecasting data:', error);
      displayForecastingError();
    }
  }

  // Defensive destroy for all charts
  function safeDestroy(chart) {
    if (chart && typeof chart.destroy === 'function') {
      chart.destroy();
    }
  }

  function displayForecastingData(data) {
    console.log('Displaying forecasting data:', data);
    
    // Update forecasting UI elements
    updateElement('nextWeekHours', data.next_week_hours);
    updateElement('nextWeekConfidence', data.next_week_confidence + '%');
    updateElement('nextWeekTrend', data.next_week_trend);
    updateElement('nextWeekCI', data.next_week_ci);
    updateElement('nextWeekMethods', data.next_week_methods);

    updateElement('nextMonthHours', data.next_month_hours);
    updateElement('nextMonthConfidence', data.next_month_confidence + '%');
    updateElement('nextMonthTrend', data.next_month_trend);
    updateElement('nextMonthCI', data.next_month_ci);

    updateElement('tutorDemandWeek', data.tutor_demand_week);
    updateElement('tutorDemandMonth', data.tutor_demand_month);

    updateElement('busiestDay', data.busiest_day);
    updateElement('busiestHour', data.busiest_hour);

    updateElement('anomalyStatus', data.anomaly_status);
    updateElement('anomalyPercent', data.anomaly_percent + '%');
    updateElement('anomalyLastWeek', data.anomaly_last_week + ' anomalies');
    updateElement('anomalyPrevAvg', data.anomaly_prev_avg + 'h avg');

    updateElement('histLastWeek', data.hist_last_week + 'h');
    updateElement('histForecastWeek', data.hist_forecast_week + 'h forecast');
    updateElement('histLastMonth', data.hist_last_month + 'h');
    updateElement('histForecastMonth', data.hist_forecast_month + 'h forecast');

    updateElement('forecastLastUpdated', data.forecast_last_updated);

    // Update hourly forecast table
    updateHourlyForecastTable(data.hourly_forecast);

    // Update scenario simulation
    updateScenarioSimulation(data.scenario_simulation);
  }

  function updateElement(elementId, value) {
    const element = document.getElementById(elementId);
    if (element) {
      element.textContent = value;
    }
  }

  function updateHourlyForecastTable(hourlyData) {
    const tableElement = document.getElementById('hourlyForecastTable');
    if (!tableElement || !hourlyData) return;

    let tableHtml = `
      <table class="w-full">
        <thead class="bg-gray-50 dark:bg-gray-700">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Hour</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Predicted Hours</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Predicted Sessions</th>
          </tr>
        </thead>
        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-600">
    `;

    for (let hour = 0; hour < 24; hour++) {
      const hourData = hourlyData[hour] || { predicted_hours: 0, predicted_sessions: 0 };
      tableHtml += `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
          <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">${hour.toString().padStart(2, '0')}:00</td>
          <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">${hourData.predicted_hours}h</td>
          <td class="px-4 py-3 text-sm text-gray-700 dark:text-gray-300">${hourData.predicted_sessions}</td>
        </tr>
      `;
    }

    tableHtml += '</tbody></table>';
    tableElement.innerHTML = tableHtml;
  }

  function updateScenarioSimulation(scenarios) {
    if (!scenarios) return;
    
    updateElement('simTutors2', scenarios['+2_tutors'] ? scenarios['+2_tutors'] + 'h' : '-');
    updateElement('simTutors5', scenarios['+5_tutors'] ? scenarios['+5_tutors'] + 'h' : '-');
    updateElement('simTutors10', scenarios['+10_tutors'] ? scenarios['+10_tutors'] + 'h' : '-');
  }

  function displayForecastingError() {
    const errorElements = [
      'nextWeekHours', 'nextWeekConfidence', 'nextWeekTrend', 'nextWeekCI', 'nextWeekMethods',
      'nextMonthHours', 'nextMonthConfidence', 'nextMonthTrend', 'nextMonthCI',
      'tutorDemandWeek', 'tutorDemandMonth',
      'busiestDay', 'busiestHour',
      'anomalyStatus', 'anomalyPercent', 'anomalyLastWeek', 'anomalyPrevAvg',
      'histLastWeek', 'histForecastWeek', 'histLastMonth', 'histForecastMonth',
      'forecastLastUpdated'
    ];
    errorElements.forEach(id => {
      updateElement(id, 'Error');
    });
  }

  // AI Insights Functions
  async function loadAIInsights() {
    try {
      const response = await fetch('/api/ai-insights');
      if (response.ok) {
        const data = await response.json();
        displayAIInsights(data);
      } else {
        console.error('Error loading AI insights');
        displayAIInsightsError();
      }
    } catch (error) {
      console.error('Error loading AI insights:', error);
      displayAIInsightsError();
    }
  }

  function displayAIInsights(data) {
    // Update AI confidence score
    updateElement('aiConfidenceScore', data.confidence_score + '%');

    // Update forecast accuracy
    updateElement('forecastAccuracy', data.forecast_accuracy + '%');

    // Update NLP summary
    const summaryElement = document.getElementById('improvedNLSummary');
    if (summaryElement && data.nlp_summary) {
      const spanElement = summaryElement.querySelector('span');
      if (spanElement) {
        spanElement.textContent = data.nlp_summary;
      }
    }

    // Update AI recommendations
    updateAIRecommendations(data.ai_recommendations);

    // Update growth opportunities
    updateGrowthOpportunities(data.growth_opportunities);
  }

  function updateAIRecommendations(recommendations) {
    const recommendationsElement = document.getElementById('aiRecommendations');
    if (!recommendationsElement) return;

    if (recommendations && recommendations.length > 0) {
      const recommendationsHtml = recommendations.map(rec => `
        <div class="card mb-3 ${getRecommendationCardClass(rec.priority)}">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h6 class="card-title mb-1">
                  <i class="fas ${getRecommendationIcon(rec.type)} me-2"></i>
                  ${rec.title}
                </h6>
                <p class="card-text small mb-2">${rec.description}</p>
                <div class="row">
                  <div class="col-md-6">
                    <strong>Action:</strong> ${rec.action}
                  </div>
                  <div class="col-md-6">
                    <strong>Impact:</strong> ${rec.impact}
                  </div>
                </div>
              </div>
              <span class="badge ${getPriorityBadgeClass(rec.priority)}">${rec.priority}</span>
            </div>
          </div>
        </div>
      `).join('');
      recommendationsElement.innerHTML = recommendationsHtml;
    } else {
      recommendationsElement.innerHTML = '<div class="text-muted">No recommendations available</div>';
    }
  }

  function updateGrowthOpportunities(opportunities) {
    const opportunitiesElement = document.getElementById('topGrowthOpportunities');
    if (!opportunitiesElement) return;

    if (opportunities && opportunities.length > 0) {
      const opportunitiesHtml = opportunities.map(opp => 
        `<li class="mb-1 flex items-center"><i class="fas fa-arrow-up text-green-600 dark:text-green-400 mr-2"></i><span class="text-gray-700 dark:text-gray-300">${opp}</span></li>`
      ).join('');
      opportunitiesElement.innerHTML = opportunitiesHtml;
    } else {
      opportunitiesElement.innerHTML = '<li class="text-gray-500 dark:text-gray-400">No specific opportunities identified</li>';
    }
  }

  function getRecommendationCardClass(priority) {
    switch (priority) {
      case 'high': return 'border-danger';
      case 'medium': return 'border-warning';
      case 'low': return 'border-info';
      default: return 'border-secondary';
    }
  }

  function getRecommendationIcon(type) {
    switch (type) {
      case 'staffing': return 'fa-users';
      case 'schedule': return 'fa-clock';
      case 'quality': return 'fa-star';
      case 'growth': return 'fa-chart-line';
      case 'consistency': return 'fa-chart-bar';
      default: return 'fa-lightbulb';
    }
  }

  function getPriorityBadgeClass(priority) {
    switch (priority) {
      case 'high': return 'bg-danger';
      case 'medium': return 'bg-warning text-dark';
      case 'low': return 'bg-info';
      default: return 'bg-secondary';
    }
  }

  function displayAIInsightsError() {
    updateElement('aiConfidenceScore', 'Error');
    updateElement('forecastAccuracy', 'Error');
    
    const summaryElement = document.getElementById('improvedNLSummary');
    if (summaryElement) {
      const spanElement = summaryElement.querySelector('span');
      if (spanElement) {
        spanElement.textContent = 'Failed to load AI insights';
      }
    }
  }
</script>
</body>
</html>
