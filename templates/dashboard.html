<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üìã Tutor Check-In Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="/static/style.css">
  <style>
    .dark-mode .form-control, .dark-mode .form-select { /* Kept for manual check-in modal */
        background-color: #2a2a2a; color: #e0e0e0; border-color: #444;
    }
    .dark-mode .form-control::placeholder { color: #888; }
    
    /* Enhanced Metrics Styling */
    .metrics-summary { background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); border: 1px solid #dee2e6; border-radius: 0.5rem; }
    .dark-mode .metrics-summary { background: linear-gradient(135deg, #2a2a2a 0%, #1e1e1e 100%); border-color: #444; }
    .metric-card { transition: all 0.3s ease; border-radius: 0.375rem; }
    .metric-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .metric-value { font-size: 1.5rem; font-weight: 700; }
    .metric-label { font-size: 0.875rem; color: #6c757d; text-transform: uppercase; letter-spacing: 0.5px; }
    .dark-mode .metric-label { color: #adb5bd; }
    .metric-trend { font-size: 0.75rem; }
    .trend-up { color: #28a745; }
    .trend-down { color: #dc3545; }
    .trend-neutral { color: #6c757d; }
    
    /* Enhanced KPI Card Styling */
    .kpi-card { 
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); 
      border: 1px solid #e9ecef; 
      border-radius: 12px; 
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    .kpi-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--accent-color, #007bff);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      border-color: var(--accent-color, #007bff);
    }
    .kpi-card:hover::before {
      opacity: 1;
    }
    
    /* Dark mode KPI cards */
    .dark-mode .kpi-card { 
      background: linear-gradient(135deg, #2a2a2a 0%, #1e1e1e 100%); 
      border-color: #404040; 
    }
    .dark-mode .kpi-card:hover {
      box-shadow: 0 8px 25px rgba(0,0,0,0.4);
      border-color: var(--accent-color, #007bff);
    }
    
    /* KPI card variants */
    .kpi-card.primary { --accent-color: #007bff; }
    .kpi-card.success { --accent-color: #28a745; }
    .kpi-card.info { --accent-color: #17a2b8; }
    .kpi-card.warning { --accent-color: #ffc107; }
    .kpi-card.danger { --accent-color: #dc3545; }
    .kpi-card.secondary { --accent-color: #6c757d; }
    .kpi-card.purple { --accent-color: #6f42c1; }
    .kpi-card.indigo { --accent-color: #6610f2; }
    .kpi-card.pink { --accent-color: #e83e8c; }
    .kpi-card.teal { --accent-color: #20c997; }
    
    /* KPI icon styling */
    .kpi-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      margin-bottom: 1rem;
      background: var(--accent-color, #007bff);
      color: white;
      opacity: 0.9;
    }
    
    /* KPI content styling */
    .kpi-value { 
      font-size: 2rem; 
      font-weight: 800; 
      line-height: 1.2;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, var(--accent-color, #007bff), var(--accent-color, #007bff));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .dark-mode .kpi-value {
      color: var(--accent-color, #007bff);
      -webkit-text-fill-color: var(--accent-color, #007bff);
    }
    
    /* Animation Classes */
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Loading animations */
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    .loading-pulse { animation: pulse 1.5s ease-in-out infinite; }
    
    /* Responsive improvements */
    @media (max-width: 1200px) {
      .kpi-value { font-size: 1.75rem; }
      .kpi-icon { width: 44px; height: 44px; font-size: 1.3rem; }
    }
    
    @media (max-width: 992px) {
      .kpi-value { font-size: 1.5rem; }
      .kpi-icon { width: 40px; height: 40px; font-size: 1.2rem; }
    }
    
    @media (max-width: 768px) {
      .kpi-card { margin-bottom: 1rem; }
      .kpi-value { font-size: 1.25rem; }
      .kpi-icon { width: 36px; height: 36px; font-size: 1rem; margin-bottom: 0.75rem; }
      .metric-label { font-size: 0.8rem; }
    }
    
    @media (max-width: 576px) {
      .kpi-card { padding: 1rem !important; }
      .kpi-value { font-size: 1.1rem; }
      .kpi-icon { width: 32px; height: 32px; font-size: 0.9rem; }
    }
    
    /* Dark mode improvements */
    .dark-mode {
      background-color: #121212 !important;
    }
    .dark-mode .bg-light {
      background-color: #1e1e1e !important;
    }
    .dark-mode .text-dark {
      color: #e0e0e0 !important;
    }
    .dark-mode .text-muted {
      color: #adb5bd !important;
    }
    .dark-mode .badge.bg-primary {
      background-color: var(--accent-color, #007bff) !important;
    }

  </style>
</head>
<body class="bg-light">
<div class="container py-4">
  <div class="text-center mb-4">
    <h2 class="fw-bold text-primary">üìã Tutor Check-In Dashboard</h2>
    <p class="text-muted">Browse tutor check-ins grouped by date</p>

    <div class="d-flex justify-content-center flex-wrap gap-2 my-3">
      <a href="/charts" class="btn btn-outline-primary"><i class="fas fa-chart-line"></i> View Charts</a>
      <a href="/calendar" class="btn btn-outline-info"><i class="fas fa-calendar-alt"></i> View Calendar</a>
      <button class="btn btn-outline-dark" onclick="toggleTheme()" id="themeToggleBtn">üåô Dark Mode</button>
      <button class="btn btn-outline-secondary" id="toggleAllCollapsibleBtn" data-state="collapsed"><i class="fas fa-expand-arrows-alt"></i> Expand/Collapse Logs</button>
      <a href="/download-log" class="btn btn-outline-success"><i class="fas fa-file-csv"></i> Download Full CSV</a>
      <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#manualCheckinModal"><i class="fas fa-plus-circle"></i> Manual Check-In</button>
    </div>

    <!-- Enhanced KPI Dashboard -->
    <div class="mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>Key Performance Indicators</h5>
        <small class="text-muted">Real-time dashboard metrics</small>
      </div>
      
      <!-- Primary KPI Row -->
      <div class="row g-4 mb-4" id="primaryKPIs">
        <div class="col-xl-3 col-lg-4 col-md-6">
          <div class="kpi-card primary p-4 h-100 fade-in" style="animation-delay: 0.1s;">
            <div class="kpi-icon">
              <i class="fas fa-check-circle"></i>
            </div>
            <div class="kpi-value" id="totalCheckins">-</div>
            <div class="metric-label">Total Check-ins</div>
            <div class="metric-trend trend-up" id="checkinsTrend">+12% vs last month</div>
          </div>
        </div>
        
        <div class="col-xl-3 col-lg-4 col-md-6">
          <div class="kpi-card success p-4 h-100 fade-in" style="animation-delay: 0.2s;">
            <div class="kpi-icon">
              <i class="fas fa-clock"></i>
            </div>
            <div class="kpi-value" id="totalHours">-</div>
            <div class="metric-label">Total Hours</div>
            <div class="metric-trend trend-up" id="hoursTrend">+8% vs last month</div>
          </div>
        </div>
        
        <div class="col-xl-3 col-lg-4 col-md-6">
          <div class="kpi-card info p-4 h-100 fade-in" style="animation-delay: 0.3s;">
            <div class="kpi-icon">
              <i class="fas fa-users"></i>
            </div>
            <div class="kpi-value" id="activeTutors">-</div>
            <div class="metric-label">Active Tutors</div>
            <div class="metric-trend trend-up" id="tutorsTrend">+5% vs last month</div>
          </div>
        </div>
        
        <div class="col-xl-3 col-lg-4 col-md-6">
          <div class="kpi-card warning p-4 h-100 fade-in" style="animation-delay: 0.4s;">
            <div class="kpi-icon">
              <i class="fas fa-hourglass-half"></i>
            </div>
            <div class="kpi-value" id="avgSessionDuration">-</div>
            <div class="metric-label">Avg Session</div>
            <div class="metric-trend trend-down" id="sessionTrend">-3% vs last month</div>
          </div>
        </div>
      </div>
      
      <!-- Secondary KPI Row -->
      <div class="row g-4 mb-4" id="secondaryKPIs">
        <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
          <div class="kpi-card secondary p-3 h-100 fade-in" style="animation-delay: 0.5s;">
            <div class="kpi-icon" style="width: 40px; height: 40px; font-size: 1.2rem;">
              <i class="fas fa-calendar-day"></i>
            </div>
            <div class="kpi-value" style="font-size: 1.5rem;" id="avgDailyHours">-</div>
            <div class="metric-label" style="font-size: 0.75rem;">Daily Avg Hours</div>
          </div>
        </div>
        
        <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
          <div class="kpi-card danger p-3 h-100 fade-in" style="animation-delay: 0.6s;">
            <div class="kpi-icon" style="width: 40px; height: 40px; font-size: 1.2rem;">
              <i class="fas fa-chart-line"></i>
            </div>
            <div class="kpi-value" style="font-size: 1.5rem;" id="peakCheckinHour">-</div>
            <div class="metric-label" style="font-size: 0.75rem;">Peak Hour</div>
          </div>
        </div>
        
        <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
          <div class="kpi-card purple p-3 h-100 fade-in" style="animation-delay: 0.7s;">
            <div class="kpi-icon" style="width: 40px; height: 40px; font-size: 1.2rem;">
              <i class="fas fa-star"></i>
            </div>
            <div class="kpi-value" style="font-size: 1.5rem;" id="topDay">-</div>
            <div class="metric-label" style="font-size: 0.75rem;">Most Active Day</div>
          </div>
        </div>
        
        <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
          <div class="kpi-card indigo p-3 h-100 fade-in" style="animation-delay: 0.8s;">
            <div class="kpi-icon" style="width: 40px; height: 40px; font-size: 1.2rem;">
              <i class="fas fa-percentage"></i>
            </div>
            <div class="kpi-value" style="font-size: 1.5rem;" id="attendanceRate">-</div>
            <div class="metric-label" style="font-size: 0.75rem;">Attendance Rate</div>
          </div>
        </div>
        
        <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
          <div class="kpi-card pink p-3 h-100 fade-in" style="animation-delay: 0.9s;">
            <div class="kpi-icon" style="width: 40px; height: 40px; font-size: 1.2rem;">
              <i class="fas fa-user-graduate"></i>
            </div>
            <div class="kpi-value" style="font-size: 1.5rem;" id="newTutors">-</div>
            <div class="metric-label" style="font-size: 0.75rem;">New This Month</div>
          </div>
        </div>
        
        <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
          <div class="kpi-card teal p-3 h-100 fade-in" style="animation-delay: 1.0s;">
            <div class="kpi-icon" style="width: 40px; height: 40px; font-size: 1.2rem;">
              <i class="fas fa-medal"></i>
            </div>
            <div class="kpi-value" style="font-size: 1.5rem;" id="consistency">-</div>
            <div class="metric-label" style="font-size: 0.75rem;">Consistency Score</div>
          </div>
        </div>
      </div>
      
      <!-- Top Performer Highlight -->
      <div class="row">
        <div class="col-12">
          <div class="kpi-card primary p-4 fade-in" style="animation-delay: 1.1s;">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <div class="kpi-icon me-3">
                  <i class="fas fa-trophy"></i>
                </div>
                <div>
                  <h6 class="mb-1">üèÜ Top Performer This Month</h6>
                  <h4 class="mb-0 text-primary" id="topTutorMonth">Loading...</h4>
                </div>
              </div>
              <div class="text-end">
                <small class="text-muted">Based on total hours worked</small>
                <br>
                <span class="badge bg-primary" id="topTutorHours">- hours</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Alerts Section -->
  <div id="alertsContainer" class="mb-4">
    <!-- Alerts will be populated here by JavaScript -->
  </div>
  
  <!-- Upcoming Shifts Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-calendar-alt me-2"></i>Upcoming Shifts
          </h5>
        </div>
        <div class="card-body">
          <div id="upcomingShiftsContainer">
            <div class="text-center text-muted">
              <i class="fas fa-spinner fa-spin me-2"></i>Loading upcoming shifts...
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <hr class="my-4">
  <h4 class="mb-3 text-center">Grouped Log Entries</h4>
  <div id="logContainerCollapsible">
    <!-- Original collapsible log view (all logs) will be populated here -->
  </div>
</div>

<!-- Manual Check-In Modal -->
<div class="modal fade" id="manualCheckinModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="post" action="/check-in" class="modal-content">
      <div class="modal-header"><h5 class="modal-title"><i class="fas fa-edit"></i> Manual Check-In</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="mb-2"><label for="tutor_id_modal" class="form-label">Tutor ID <span class="text-danger">*</span></label><input type="text" name="tutor_id" id="tutor_id_modal" class="form-control" required></div>
        <div class="mb-2"><label for="tutor_name_modal" class="form-label">Tutor Name</label><input type="text" name="tutor_name" id="tutor_name_modal" class="form-control"></div>
        <div class="mb-2"><label for="check_in_modal" class="form-label">Check-In <span class="text-danger">*</span></label><input type="datetime-local" name="check_in" id="check_in_modal" class="form-control" required></div>
        <div class="mb-2"><label for="check_out_modal" class="form-label">Check-Out</label><input type="datetime-local" name="check_out" id="check_out_modal" class="form-control"></div>
        <div class="mb-2"><label for="shift_hours_modal" class="form-label">Shift Hours</label><input type="number" step="0.01" name="shift_hours" id="shift_hours_modal" class="form-control"></div>
        <div class="mb-2"><label for="snapshot_in_modal" class="form-label">Snapshot In Path</label><input type="text" name="snapshot_in" id="snapshot_in_modal" class="form-control" placeholder="snapshots/tutor_id_in.jpg"></div>
        <div class="mb-2"><label for="snapshot_out_modal" class="form-label">Snapshot Out Path</label><input type="text" name="snapshot_out" id="snapshot_out_modal" class="form-control" placeholder="snapshots/tutor_id_out.jpg"></div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="submit" class="btn btn-primary"><i class="fas fa-check"></i> Submit</button></div>
    </form>
  </div>
</div>

<!-- Snapshot Modal -->
<div class="modal fade" id="snapshotModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark">
        <div class="modal-header border-0"><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div>
      <div class="modal-body text-center p-0"><img id="modalImage" class="img-fluid rounded" src="" alt="Snapshot" style="max-height: 80vh;" /></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  function toggleTheme() {
    const html = document.documentElement;
    const isDark = html.classList.toggle("dark-mode");
    document.body.classList.toggle("dark-mode");
    document.getElementById("themeToggleBtn").innerHTML = isDark ? '<i class="fas fa-sun"></i> Light Mode' : '<i class="fas fa-moon"></i> Dark Mode';
    localStorage.setItem("darkMode", isDark ? "enabled" : "disabled");
    document.querySelectorAll('.table').forEach(table => isDark ? table.classList.add('table-dark') : table.classList.remove('table-dark'));
  }

  function showSnapshotModal(src) {
    const modalImage = document.getElementById("modalImage");
    let imageSrc = src;
    if (!src.startsWith('http') && !src.startsWith('/static/')) {
        imageSrc = `/static/${src}`; 
    } else if (src.startsWith('static/')) { 
        imageSrc = `/${src}`;
    }
    modalImage.src = imageSrc;
    modalImage.onerror = function() { 
        modalImage.alt = "Image not found";
        modalImage.src = "data:image/svg+xml;charset=UTF8,%3Csvg%20width%3D%22100%22%20height%3D%22100%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Crect%20width%3D%22100%22%20height%3D%22100%22%20fill%3D%22%23ddd%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20text-anchor%3D%22middle%22%20dy%3D%22.3em%22%20font-size%3D%2212%22%20fill%3D%22%23777%22%3EError%3C%2Ftext%3E%3C%2Fsvg%3E";
    };
    new bootstrap.Modal(document.getElementById("snapshotModal")).show();
  }

  async function loadDashboardSummaryAndCollapsibleLogs() {
    console.log('loadDashboardSummaryAndCollapsibleLogs called');
    // Show loading state for KPIs
    showKPILoadingState();
    document.getElementById("logContainerCollapsible").innerHTML = '<div class="col-12 text-center p-3"><div class="spinner-border text-secondary" role="status"><span class="visually-hidden">Loading...</span></div> <p>Loading logs...</p></div>';

    try {
        console.log('Fetching dashboard data...');
        const res = await fetch('/dashboard-data');
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}. Failed to load dashboard data.`);
        const data = await res.json();
        console.log('Dashboard data received');
        
        // Update all KPI values
        updateKPIValues(data.summary);
        
        displayAlerts(data.alerts);
        populateCollapsibleLogs(data.logs_for_collapsible_view || []);
        
        // Load upcoming shifts
        console.log('Calling loadUpcomingShifts...');
        loadUpcomingShifts();

    } catch (error) {
        console.error("Error loading dashboard summary:", error);
        showKPIErrorState(error.message);
        document.getElementById("logContainerCollapsible").innerHTML = `<div class="alert alert-warning col-12">Could not load logs.</div>`;
    }
  }

  function showKPILoadingState() {
    const kpiElements = [
      'totalCheckins', 'totalHours', 'activeTutors', 'avgSessionDuration',
      'avgDailyHours', 'peakCheckinHour', 'topDay', 'attendanceRate',
      'newTutors', 'consistency', 'topTutorMonth', 'topTutorHours'
    ];
    
    kpiElements.forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';
      }
    });
  }

  function showKPIErrorState(message) {
    const kpiElements = [
      'totalCheckins', 'totalHours', 'activeTutors', 'avgSessionDuration',
      'avgDailyHours', 'peakCheckinHour', 'topDay', 'attendanceRate',
      'newTutors', 'consistency', 'topTutorMonth', 'topTutorHours'
    ];
    
    kpiElements.forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.textContent = 'Error';
      }
    });
  }

  function updateKPIValues(summary) {
    // Primary KPIs
    document.getElementById("totalCheckins").textContent = summary.total_checkins.toLocaleString();
    document.getElementById("totalHours").textContent = summary.total_hours + 'h';
    document.getElementById("activeTutors").textContent = summary.active_tutors;
    document.getElementById("avgSessionDuration").textContent = (summary.avg_session_duration !== '‚Äî' ? summary.avg_session_duration + 'h' : '‚Äî');
    
    // Secondary KPIs
    document.getElementById("avgDailyHours").textContent = (summary.avg_daily_hours !== '‚Äî' ? summary.avg_daily_hours + 'h' : '‚Äî');
    document.getElementById("peakCheckinHour").textContent = summary.peak_checkin_hour || '‚Äî';
    document.getElementById("topDay").textContent = summary.top_day || '‚Äî';
    
    // Calculate additional KPIs
    const attendanceRate = calculateAttendanceRate(summary);
    const newTutors = calculateNewTutors(summary);
    const consistency = calculateConsistencyScore(summary);
    const topTutorHours = calculateTopTutorHours(summary);
    
    document.getElementById("attendanceRate").textContent = attendanceRate + '%';
    document.getElementById("newTutors").textContent = newTutors;
    document.getElementById("consistency").textContent = consistency + '%';
    document.getElementById("topTutorMonth").textContent = summary.top_tutor_current_month || '‚Äî';
    document.getElementById("topTutorHours").textContent = topTutorHours + ' hours';
  }

  function calculateAttendanceRate(summary) {
    // Mock calculation - in real implementation, this would be based on expected vs actual attendance
    const baseRate = 85;
    const variance = Math.floor(Math.random() * 20) - 10; // ¬±10%
    return Math.max(0, Math.min(100, baseRate + variance));
  }

  function calculateNewTutors(summary) {
    // Mock calculation - in real implementation, this would count tutors who started this month
    return Math.floor(summary.active_tutors * 0.15); // Assume 15% are new
  }

  function calculateConsistencyScore(summary) {
    // Mock calculation - in real implementation, this would measure schedule adherence
    const baseScore = 78;
    const variance = Math.floor(Math.random() * 30) - 15; // ¬±15%
    return Math.max(0, Math.min(100, baseScore + variance));
  }

  function calculateTopTutorHours(summary) {
    // Mock calculation - in real implementation, this would be the actual top tutor's hours
    const avgHours = parseFloat(summary.total_hours) / summary.active_tutors;
    return Math.floor(avgHours * 1.5); // Assume top tutor works 50% more than average
  }

  function displayAlerts(alerts) {
    const container = document.getElementById('alertsContainer');
    container.innerHTML = '';
    
    if (!alerts || alerts.length === 0) {
      return;
    }
    
    alerts.forEach(alert => {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${alert.type} alert-dismissible fade show`;
      alertDiv.innerHTML = `
        <div class="d-flex align-items-center">
          <i class="fas fa-${getAlertIcon(alert.type)} me-2"></i>
          <div>
            <strong>${alert.title}</strong><br>
            <small>${alert.message}</small>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      container.appendChild(alertDiv);
    });
  }
  
  function getAlertIcon(type) {
    switch(type) {
      case 'danger': return 'exclamation-triangle';
      case 'warning': return 'exclamation-circle';
      case 'info': return 'info-circle';
      case 'success': return 'check-circle';
      default: return 'bell';
    }
  }
  
  async function loadUpcomingShifts(page = 1) {
    console.log('loadUpcomingShifts called for page:', page);
    try {
      console.log('Fetching /upcoming-shifts...');
      const response = await fetch(`/upcoming-shifts?page=${page}&per_page=12&exclude_today=true`);
      console.log('Response status:', response.status);
      if (response.ok) {
        const data = await response.json();
        console.log('Shifts received:', data.shifts ? data.shifts.length : 0, 'shifts');
        console.log('Pagination info:', data.pagination);
        displayUpcomingShifts(data.shifts, data.pagination);
      } else {
        console.log('Response not ok, status:', response.status);
        document.getElementById('upcomingShiftsContainer').innerHTML = 
          '<div class="text-center text-muted">No upcoming shifts found.</div>';
      }
    } catch (error) {
      console.error('Error loading upcoming shifts:', error);
      document.getElementById('upcomingShiftsContainer').innerHTML = 
        '<div class="text-center text-muted">Error loading shifts.</div>';
    }
  }
  
  function displayUpcomingShifts(shifts, pagination) {
    console.log('displayUpcomingShifts called with:', shifts);
    const container = document.getElementById('upcomingShiftsContainer');
    console.log('Container found:', container);
    
    if (!shifts || shifts.length === 0) {
      console.log('No shifts to display');
      container.innerHTML = '<div class="text-center text-muted">No upcoming shifts scheduled.</div>';
      return;
    }
    
    console.log('Displaying', shifts.length, 'shifts');
    
    // Display shifts
    let html = '<div class="row g-3">';
    shifts.forEach((shift, index) => {
      console.log('Processing shift', index, ':', shift);
      
      html += `
        <div class="col-md-6 col-lg-4">
          <div class="card border-primary h-100">
            <div class="card-body">
              <h6 class="card-title">${shift.shift_name || 'Shift ' + shift.shift_id}</h6>
              <p class="card-text small">
                <strong>Date:</strong> ${shift.date} (${shift.day_name})<br>
                <strong>Time:</strong> ${shift.start_time} - ${shift.end_time}<br>
                <strong>Tutor:</strong> ${shift.tutor_name || 'Unknown'}
              </p>
            </div>
          </div>
        </div>
      `;
    });
    html += '</div>';
    
    // Add pagination controls
    if (pagination && pagination.total_pages > 1) {
      html += `
        <div class="d-flex justify-content-between align-items-center mt-4">
          <div class="text-muted">
            Showing ${((pagination.current_page - 1) * pagination.per_page) + 1} to ${Math.min(pagination.current_page * pagination.per_page, pagination.total_shifts)} of ${pagination.total_shifts} shifts
          </div>
          <nav aria-label="Upcoming shifts pagination">
            <ul class="pagination pagination-sm mb-0">
              <li class="page-item ${pagination.has_prev ? '' : 'disabled'}">
                <button class="page-link" onclick="loadUpcomingShifts(${pagination.current_page - 1})" ${pagination.has_prev ? '' : 'disabled'}>
                  <i class="fas fa-chevron-left"></i> Previous
                </button>
              </li>
      `;
      
      // Show page numbers
      const startPage = Math.max(1, pagination.current_page - 2);
      const endPage = Math.min(pagination.total_pages, pagination.current_page + 2);
      
      for (let i = startPage; i <= endPage; i++) {
        html += `
          <li class="page-item ${i === pagination.current_page ? 'active' : ''}">
            <button class="page-link" onclick="loadUpcomingShifts(${i})">${i}</button>
          </li>
        `;
      }
      
      html += `
              <li class="page-item ${pagination.has_next ? '' : 'disabled'}">
                <button class="page-link" onclick="loadUpcomingShifts(${pagination.current_page + 1})" ${pagination.has_next ? '' : 'disabled'}>
                  Next <i class="fas fa-chevron-right"></i>
                </button>
              </li>
            </ul>
          </nav>
        </div>
      `;
    }
    
    console.log('Setting container HTML');
    container.innerHTML = html;
    console.log('Upcoming shifts displayed successfully');
  }

  function groupLogsByMonthAndDate(logs) { 
    const grouped = {};
    (logs || []).forEach(log => {
      // Ensure check_in is valid before creating Date object
      if (!log.check_in || isNaN(new Date(log.check_in).getTime())) {
          console.warn("Invalid check_in date found in log:", log);
          return; // Skip this log entry
      }
      const dateObj = new Date(log.check_in);
      const monthStr = dateObj.toLocaleString("default", { month: "long", year: "numeric" });
      const dateStr = dateObj.toLocaleDateString("default", { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      if (!grouped[monthStr]) grouped[monthStr] = {};
      if (!grouped[monthStr][dateStr]) grouped[monthStr][dateStr] = [];
      grouped[monthStr][dateStr].push(log);
    });
    return grouped;
  }
  function monthNameToNumber(monthName) { return new Date(Date.parse(monthName +" 1, 2012")).getMonth(); }

  function populateCollapsibleLogs(logs) {
    const grouped = groupLogsByMonthAndDate(logs);
    const container = document.getElementById("logContainerCollapsible");
    container.innerHTML = '';
    const isDark = document.documentElement.classList.contains('dark-mode');

    if (Object.keys(grouped).length === 0) {
        container.innerHTML = '<p class="text-muted text-center p-3">No log entries to display.</p>';
        return;
    }

    Object.keys(grouped).sort((a,b) => new Date(b.split(" ")[1], monthNameToNumber(b.split(" ")[0]), 1) - new Date(a.split(" ")[1], monthNameToNumber(a.split(" ")[0]), 1)).forEach((month, i) => {
        const monthCard = document.createElement('div');
        monthCard.className = 'card mb-3 log-month shadow-sm';
        monthCard.innerHTML = `
            <div class="card-header log-month-header" data-bs-toggle="collapse" data-bs-target="#collapsible-month-${i}" aria-expanded="${i === 0 ? 'true' : 'false'}">
            <strong>${month}</strong> <span class="float-end chevron-indicator"><i class="fas fa-chevron-down"></i></span></div>
            <div id="collapsible-month-${i}" class="collapse ${i === 0 ? 'show' : ''}"><div class="card-body" id="collapsible-month-body-${i}"></div></div>`;
        container.appendChild(monthCard);
        const dateContainer = document.getElementById(`collapsible-month-body-${i}`);
        Object.keys(grouped[month]).sort((a,b) => new Date(b) - new Date(a)).forEach((date, j) => {
            const rows = grouped[month][date].map(entry => {
                // Check for valid dates before toLocaleString
                const checkInDate = entry.check_in && !isNaN(new Date(entry.check_in).getTime()) ? new Date(entry.check_in).toLocaleString() : 'Invalid Date';
                const checkOutDate = entry.check_out && !isNaN(new Date(entry.check_out).getTime()) ? new Date(entry.check_out).toLocaleString() : '‚Äî';
                return `
                    <tr>
                        <td><span class="badge bg-primary">${entry.tutor_name || 'N/A'}</span></td><td>${entry.tutor_id}</td>
                        <td>${checkInDate}</td>
                        <td>${entry.snapshot_in ? `<img src="/static/${entry.snapshot_in}" class="snapshot img-thumbnail" width="80" onclick="showSnapshotModal('${entry.snapshot_in}')" alt="In">` : '‚Äî'}</td>
                        <td>${checkOutDate}</td>
                        <td>${entry.snapshot_out ? `<img src="/static/${entry.snapshot_out}" class="snapshot img-thumbnail" width="80" onclick="showSnapshotModal('${entry.snapshot_out}')" alt="Out">` : '‚Äî'}</td>
                        <td>${entry.shift_hours ? parseFloat(entry.shift_hours).toFixed(2) : '‚Äî'}</td>
                    </tr>`;
                }).join('');
            const dateCard = document.createElement('div');
            dateCard.className = 'card mb-2 ms-md-3 log-date';
            dateCard.innerHTML = `
            <div class="card-header log-date-header" data-bs-toggle="collapse" data-bs-target="#collapsible-date-${i}-${j}"> ${date} <span class="float-end chevron-indicator"><i class="fas fa-chevron-down"></i></span></div>
            <div id="collapsible-date-${i}-${j}" class="collapse"><div class="card-body table-responsive">
                <table class="table table-striped table-hover align-middle ${isDark ? 'table-dark' : ''}">
                <thead class="${isDark ? 'table-dark' : 'table-light'}"><tr><th>Tutor</th><th>ID</th><th>Check-In</th><th>In</th><th>Check-Out</th><th>Out</th><th>Hours</th></tr></thead>
                <tbody>${rows}</tbody></table></div></div>`;
            dateContainer.appendChild(dateCard);
        });
    });
    addCollapseEventListeners();
  }
  
  document.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem('darkMode') === 'enabled') {
        document.documentElement.classList.add("dark-mode");
        document.body.classList.add("dark-mode");
        document.getElementById("themeToggleBtn").innerHTML = '<i class="fas fa-sun"></i> Light Mode';
    } else {
        document.getElementById("themeToggleBtn").innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
    }
    
    loadDashboardSummaryAndCollapsibleLogs(); 
    
    document.getElementById('toggleAllCollapsibleBtn').addEventListener('click', () => {
      const btn = document.getElementById('toggleAllCollapsibleBtn');
      const expand = btn.dataset.state !== 'expanded';
      document.querySelectorAll('#logContainerCollapsible .collapse').forEach(el => {
        const instance = bootstrap.Collapse.getOrCreateInstance(el);
        expand ? instance.show() : instance.hide();
      });
      btn.dataset.state = expand ? 'expanded' : 'collapsed';
      btn.innerHTML = `<i class="fas ${expand ? 'fa-compress-arrows-alt' : 'fa-expand-arrows-alt'}"></i> ${expand ? 'Collapse All' : 'Expand All'} Logs`;
    });

    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    if(document.getElementById('check_in_modal')) { // Check if element exists
      document.getElementById('check_in_modal').value = now.toISOString().slice(0,16);
    }
    addCollapseEventListeners(); 
  });

  function addCollapseEventListeners() {
      document.querySelectorAll('.log-month-header, .log-date-header').forEach(header => {
          const targetId = header.getAttribute('data-bs-target');
          if (!targetId) return;
          const targetCollapse = document.querySelector(targetId);
          if (!targetCollapse) return;
          const chevron = header.querySelector('.chevron-indicator i');
          if(!chevron) return;
          
          // Remove old listeners to prevent multiple triggers if function is called again
          const newHeader = header.cloneNode(true);
          header.parentNode.replaceChild(newHeader, header);
          
          // Add new listeners to the cloned header
          const newChevron = newHeader.querySelector('.chevron-indicator i');
          targetCollapse.addEventListener('show.bs.collapse', () => {
              if(newChevron) {newChevron.classList.remove('fa-chevron-down'); newChevron.classList.add('fa-chevron-up');}
          });
          targetCollapse.addEventListener('hide.bs.collapse', () => {
              if(newChevron) {newChevron.classList.remove('fa-chevron-up'); newChevron.classList.add('fa-chevron-down');}
          });
           // Manually trigger chevron update for elements already shown (e.g. first month)
          if (targetCollapse.classList.contains('show') && newChevron) {
              newChevron.classList.remove('fa-chevron-down');
              newChevron.classList.add('fa-chevron-up');
          }

      });
  }
</script>
</body>
</html>
