<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>📊 Tutor Analytics</title>
  <link rel="icon" href="/static/snapshots/2192067.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#ffffff">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="/static/css/global.css">
  <script src="/static/js/theme-switcher.js"></script>
  <script src="/static/js/error_handler.js"></script>
  <script>
    // Prevent admin_navbar.js from injecting - set flag before body loads
    (function () {
      // Set flag on document to prevent admin_navbar injection
      document.documentElement.setAttribute('data-no-admin-navbar', 'true');

      // Also set on body when it's available
      if (document.body) {
        document.body.setAttribute('data-no-admin-navbar', 'true');
      } else {
        document.addEventListener('DOMContentLoaded', () => {
          if (document.body) {
            document.body.setAttribute('data-no-admin-navbar', 'true');
          }
        });
      }
    })();

    // Force theme persistence - run immediately before any other scripts
    (function () {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);

      // Watch for any attempts to remove the theme
      const observer = new MutationObserver(() => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        if (!currentTheme || currentTheme !== savedTheme) {
          document.documentElement.setAttribute('data-theme', savedTheme);
        }
      });

      observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['data-theme']
      });

      // Also check periodically
      setInterval(() => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const saved = localStorage.getItem('theme') || 'light';
        if (currentTheme !== saved) {
          document.documentElement.setAttribute('data-theme', saved);
        }
      }, 500);
    })();
  </script>
  <style>
    /* ===== CHARTS PAGE THEME STYLING ===== */

    /* Page Background */
    body.charts-page {
      background-color: var(--bg-primary) !important;
      color: var(--text-primary) !important;
    }

    [data-theme="dark"] body.charts-page {
      background-color: var(--bg-primary) !important;
      color: var(--text-primary) !important;
    }

    /* Dashboard Header Styling (exact match from dashboard.html) */
    .dashboard-header {
      background: linear-gradient(135deg, #6a77e8 0%, #7a68b6 60%, #e08cf6 100%) !important;
      color: white !important;
      padding: 1.5rem 0 !important;
      margin-bottom: 1rem !important;
      border-radius: 0 0 1.25rem 1.25rem !important;
      position: relative !important;
      overflow: hidden !important;
      box-shadow: 0 6px 24px rgba(102, 126, 234, 0.25) !important;
    }

    /* Dark theme override for header to match navbar */
    [data-theme="dark"] .dashboard-header {
      background: linear-gradient(135deg, #3730a3 0%, #5b21b6 60%, #7c3aed 100%) !important;
      box-shadow: 0 8px 28px rgba(0, 0, 0, 0.45) !important;
    }

    /* Ensure header stays visible */
    .dashboard-header,
    [data-theme="dark"] .dashboard-header,
    [data-theme="light"] .dashboard-header {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }

    /* Constrain header inner content */
    .dashboard-header .text-center {
      max-width: 1200px;
      margin: 0 auto;
    }

    .dashboard-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background:
        radial-gradient(circle at 30% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 70% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
      animation: pulse 4s ease-in-out infinite;
      z-index: 0;
      pointer-events: none;
      /* prevent overlay from blocking clicks */
    }

    [data-theme="dark"] .dashboard-header::before {
      background:
        radial-gradient(circle at 30% 20%, rgba(255, 255, 255, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 70% 80%, rgba(255, 255, 255, 0.06) 0%, transparent 50%);
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 0.5;
      }

      50% {
        opacity: 1;
      }
    }

    .dashboard-header h2 {
      color: var(--text-light);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.25);
      position: relative;
      z-index: 1;
      font-size: 2rem;
      line-height: 1.2;
      margin-bottom: 0.25rem;
    }

    .dashboard-header p {
      color: rgba(255, 255, 255, 0.9);
      position: relative;
      z-index: 1;
      font-size: 0.95rem;
      margin: 0;
    }

    /* Charts Navbar - Uses app-navbar styling from global.css, just custom buttons */
    .charts-navbar {
      margin-bottom: 0 !important;
      background: linear-gradient(135deg, #6a77e8 0%, #7a68b6 55%, #e08cf6 100%) !important;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }

    [data-theme="dark"] .charts-navbar {
      background: linear-gradient(135deg, #3730a3 0%, #5b21b6 60%, #7c3aed 100%) !important;
    }

    .charts-navbar .btn-back,
    .charts-navbar .btn-logout {
      background: rgba(255, 255, 255, 0.2);
      color: white !important;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      padding: 0.5rem 1rem;
      font-weight: 600;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      font-size: 0.875rem;
      white-space: nowrap;
    }

    .charts-navbar .btn-back:hover,
    .charts-navbar .btn-logout:hover {
      background: rgba(255, 255, 255, 0.3) !important;
      border-color: rgba(255, 255, 255, 0.5) !important;
      color: white !important;
      text-decoration: none;
    }

    [data-theme="dark"] .charts-navbar .btn-back,
    [data-theme="dark"] .charts-navbar .btn-logout {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.25);
      color: white !important;
    }

    [data-theme="dark"] .charts-navbar .btn-back:hover,
    [data-theme="dark"] .charts-navbar .btn-logout:hover {
      background: rgba(255, 255, 255, 0.18) !important;
      border-color: rgba(255, 255, 255, 0.35) !important;
      color: white !important;
    }

    /* Responsive navbar */
    @media (max-width: 768px) {
      .charts-navbar .d-flex {
        flex-direction: column;
        gap: 0.5rem !important;
        width: 100%;
      }

      .charts-navbar .btn-back,
      .charts-navbar .btn-logout {
        width: 100%;
        justify-content: center;
      }
    }

    /* Form Controls - Enhanced Theme Support */
    .form-control,
    .form-select {
      background-color: var(--bg-card) !important;
      color: var(--text-primary) !important;
      border: 1px solid var(--border-color) !important;
      transition: all var(--transition-normal) !important;
    }

    .form-control::placeholder,
    .form-select::placeholder {
      color: var(--text-muted) !important;
    }

    .form-control:focus,
    .form-select:focus {
      background-color: var(--bg-card) !important;
      color: var(--text-primary) !important;
      border-color: var(--border-focus) !important;
      box-shadow: 0 0 0 0.2rem rgba(var(--primary-color-rgb), 0.25) !important;
    }

    /* Filter Chips - Enhanced Styling */
    .filter-chip {
      display: inline-block;
      padding: 0.4em 0.8em;
      font-size: 0.85em;
      margin-right: 8px;
      margin-bottom: 8px;
      background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      color: var(--text-secondary);
      font-weight: var(--font-medium);
      transition: all var(--transition-normal);
      box-shadow: var(--shadow-xs);
    }

    .filter-chip:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
      color: var(--text-light);
      border-color: var(--primary-color);
    }

    .dark-mode .filter-chip {
      background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
      border-color: #555;
      color: #ccc;
    }

    .dark-mode .filter-chip:hover {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
      color: var(--text-light);
    }

    /* Range Slider Group */
    .range-slider-group {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .range-slider-group input[type="range"] {
      flex-grow: 1;
      -webkit-appearance: none;
      height: 6px;
      border-radius: var(--radius-full);
      background: var(--border-light);
      outline: none;
      transition: all var(--transition-normal);
    }

    .range-slider-group input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: var(--radius-full);
      background: var(--primary-color);
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: all var(--transition-normal);
    }

    .range-slider-group input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      box-shadow: var(--shadow-md);
    }

    .range-value-display {
      font-variant-numeric: tabular-nums;
      font-weight: var(--font-semibold);
      color: var(--text-primary);
      min-width: 3rem;
      text-align: center;
    }

    /* Tutor Chips - Enhanced Styling */
    .tutor-chip {
      display: inline-flex;
      align-items: center;
      padding: 0.4rem 0.8rem;
      margin: 0.2rem;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
      color: var(--text-light);
      border-radius: var(--radius-lg);
      font-size: 0.85rem;
      font-weight: var(--font-medium);
      box-shadow: var(--shadow-xs);
      transition: all var(--transition-normal);
    }

    .tutor-chip:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    .tutor-chip .remove-btn {
      margin-left: 0.5rem;
      cursor: pointer;
      font-weight: bold;
      opacity: 0.8;
      transition: all var(--transition-fast);
    }

    .tutor-chip .remove-btn:hover {
      opacity: 1;
      color: #ffcccc;
      transform: scale(1.1);
    }

    /* Dropdown Styling */
    .dropdown-item.tutor-option {
      cursor: pointer;
      transition: all var(--transition-fast);
      border-radius: var(--radius-sm);
      margin: 0.1rem;
    }

    .dropdown-item.tutor-option:hover {
      background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
      transform: translateX(4px);
    }

    .dark-mode .dropdown-item.tutor-option:hover {
      background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
    }

    /* Advanced Filters Section - Enhanced */
    .advanced-filters-section {
      border-left: 4px solid var(--primary-color);
      background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
      border-radius: 0 var(--radius-md) var(--radius-md) 0;
      box-shadow: var(--shadow-sm);
      transition: all var(--transition-normal);
    }

    .dark-mode .advanced-filters-section {
      background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
      border-left-color: var(--primary-light);
    }

    .filter-section-header {
      font-weight: var(--font-semibold);
      color: var(--text-primary);
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 0.75rem;
      margin-bottom: 1.5rem;
      font-size: var(--font-size-lg);
    }

    .dark-mode .filter-section-header {
      color: var(--text-primary);
      border-bottom-color: #444;
    }

    .advanced-filter-toggle {
      transition: all var(--transition-normal);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-xs);
    }

    .advanced-filter-toggle:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    /* Metrics Summary - Enhanced */
    .metrics-summary {
      background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-secondary) 100%);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      transition: all var(--transition-normal);
    }

    .dark-mode .metrics-summary {
      background: linear-gradient(135deg, #2a2a2a 0%, #1e1e1e 100%);
      border-color: #444;
    }

    .metric-card {
      transition: all var(--transition-normal);
      border-radius: var(--radius-md);
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      box-shadow: var(--shadow-xs);
    }

    .metric-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-md);
      border-color: var(--primary-color);
    }

    .metric-value {
      font-size: 1.75rem;
      font-weight: var(--font-bold);
      color: var(--text-primary);
      line-height: var(--leading-tight);
    }

    .metric-label {
      font-size: var(--font-size-sm);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: var(--font-medium);
    }

    .dark-mode .metric-label {
      color: var(--text-muted);
    }

    .metric-trend {
      font-size: var(--font-size-xs);
      font-weight: var(--font-semibold);
    }

    .trend-up {
      color: var(--success-color);
    }

    .trend-down {
      color: var(--danger-color);
    }

    /* Chart Container Styling */
    .chart-container {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      transition: all var(--transition-normal);
      overflow: hidden;
      padding: 1rem;
    }

    /* Grid Chart Layout Enhancements */
    #gridChartLayout .chart-container {
      height: 100%;
      display: flex;
      flex-direction: column;
      min-height: 350px;
    }

    #gridChartLayout .chart-header {
      flex-shrink: 0;
      padding: 0.75rem 1rem;
    }

    #gridChartLayout .chart-body {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem;
    }

    #gridChartLayout .chart-container canvas {
      max-width: 100%;
      max-height: 100%;
    }

    #gridChartLayout .row {
      margin-bottom: 1rem;
    }

    #gridChartLayout .row:last-child {
      margin-bottom: 0;
    }

    .chart-container:hover {
      box-shadow: var(--shadow-md);
    }

    .chart-container canvas {
      background: transparent !important;
    }

    [data-theme="dark"] .chart-container {
      background: var(--bg-card);
      border-color: var(--border-color);
    }

    [data-theme="dark"] .chart-container canvas {
      background: transparent !important;
    }

    .chart-header {
      background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
      border-bottom: 1px solid var(--border-color);
      padding: 1rem 1.5rem;
    }

    .dark-mode .chart-header {
      background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
      border-bottom-color: #444;
    }

    .chart-title {
      color: var(--text-primary);
      font-weight: var(--font-semibold);
      font-size: var(--font-size-lg);
      margin: 0;
    }

    .chart-body {
      padding: 1.5rem;
      background: var(--bg-card);
    }

    .dark-mode .chart-body {
      background: #2a2a2a;
    }

    /* Comparison Mode Styling */
    .comparison-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      margin-top: 1rem;
    }

    .comparison-chart {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }

    .dark-mode .comparison-chart {
      background: #2a2a2a;
      border-color: #444;
    }

    .comparison-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
      color: var(--text-light);
      padding: 0.75rem 1rem;
      font-weight: var(--font-semibold);
      text-align: center;
    }

    .comparison-body {
      padding: 1rem;
    }

    /* Loading States */
    .chart-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 300px;
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
    }

    .dark-mode .chart-loading {
      background: #2a2a2a;
      border-color: #444;
    }

    .loading-spinner {
      width: 2rem;
      height: 2rem;
      border: 3px solid var(--border-light);
      border-top: 3px solid var(--primary-color);
      border-radius: var(--radius-full);
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .comparison-container {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .chart-header {
        padding: 0.75rem 1rem;
      }

      .chart-body {
        padding: 1rem;
      }

      .metric-value {
        font-size: 1.5rem;
      }
    }

    .trend-neutral {
      color: #6c757d;
    }

    /* Chart Enhancement */
    .chart-container-enhanced {
      position: relative;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      transition: all var(--transition-normal);
    }

    [data-theme="dark"] .chart-container-enhanced {
      background: var(--bg-card);
      border-color: var(--border-color);
    }

    .chart-header {
      background: var(--bg-gradient-primary);
      color: var(--text-light);
      padding: 1rem;
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      border-bottom: 1px solid var(--border-color);
    }

    .chart-controls {
      background: var(--bg-secondary);
      padding: 0.75rem;
      border-bottom: 1px solid var(--border-color);
    }

    [data-theme="dark"] .chart-controls {
      background: var(--bg-secondary);
      border-bottom-color: var(--border-color);
    }

    /* Animation Classes */
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .slide-in {
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(-20px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Responsive Enhancements */
    @media (max-width: 768px) {
      .metric-card {
        margin-bottom: 1rem;
      }

      .advanced-filters-section {
        margin-top: 1rem;
      }
    }

    /* Reduce extra section spacing to match dashboard */
    .mb-4 {
      margin-bottom: 1rem !important;
    }

    .mb-5 {
      margin-bottom: 1.25rem !important;
    }

    /* Custom Scrollbar */
    <h5 id="chartTitle" class="text-capitalize mb-0"><i class="fas fa-chart-area me-2"></i>Analytics Visualization </h5><div class="d-flex align-items-center gap-2"><span id="totalCount" class="badge bg-secondary"></span><div class="btn-group btn-group-sm"><button class="btn btn-outline-primary active" onclick="toggleChartLayout('single')" id="singleLayoutBtn"><i class="fas fa-square"></i>Single </button><button class="btn btn-outline-primary" onclick="toggleChartLayout('split')" id="splitLayoutBtn"><i class="fas fa-columns"></i>Split </button><button class="btn btn-outline-primary" onclick="toggleChartLayout('grid')" id="gridLayoutBtn"><i class="fas fa-th"></i>Grid </button></div></div></div></div></div>< !-- Main Chart Container --><div class="card chart-container-enhanced mb-4 shadow-sm fade-in"><div class="chart-header"><div class="d-flex justify-content-between align-items-center"><h6 class="mb-0" id="chartHeaderTitle"><i class="fas fa-chart-line me-2"></i>Analytics Dashboard </h6><div class="chart-controls-header d-flex gap-2"><button class="btn btn-light btn-sm" onclick="refreshChart()" title="Refresh Chart"><i class="fas fa-sync-alt"></i></button><button class="btn btn-light btn-sm" onclick="downloadChartImage()" title="Download Chart"><i class="fas fa-download"></i></button><button class="btn btn-light btn-sm" onclick="toggleChartFullscreen()" title="Fullscreen"><i class="fas fa-expand"></i></button></div></div></div><div class="chart-controls"><div class="d-flex justify-content-between align-items-center flex-wrap gap-2"><div class="d-flex align-items-center gap-2"><small class="text-muted"><i class="fas fa-chart-line me-1"></i>Interactive chart with real-time filtering </small><div id="chartLoadingIndicator" class="spinner-border spinner-border-sm text-primary" style="display: none;"></div></div><div class="d-flex gap-2">< !-- Chart Type Switcher --><div class="btn-group btn-group-sm"><button class="btn btn-outline-info" onclick="switchChartType('line')" title="Line Chart"><i class="fas fa-chart-line"></i></button><button class="btn btn-outline-info" onclick="switchChartType('bar')" title="Bar Chart"><i class="fas fa-chart-bar"></i></button><button class="btn btn-outline-info" onclick="switchChartType('pie')" title="Pie Chart"><i class="fas fa-chart-pie"></i></button><button class="btn btn-outline-info" onclick="switchChartType('doughnut')" title="Doughnut Chart"><i class="fas fa-circle-notch"></i></button><button class="btn btn-outline-info" onclick="switchChartType('scatter')" title="Scatter Plot"><i class="fas fa-braille"></i></button></div></div></div></div>< !-- Chart Content Area --><div class="p-3">< !-- Single Chart Layout --><div id="singleChartLayout" class="chart-layout"><div class="chart-container"><div class="chart-header"><h5 class="chart-title" id="chartTitle"><i class="fas fa-chart-bar me-2"></i>Select a dataset to view chart </h5></div><div class="chart-body"><div id="tutorChartContainer" style="position: relative; height: 60vh; min-height: 500px;"><canvas id="tutorChart"></canvas></div></div></div></div>< !-- Split Chart Layout (for comparison) --><div id="splitChartLayout" class="chart-layout" style="display: none;"><div class="comparison-container"><div class="comparison-chart"><div class="comparison-header"><i class="fas fa-chart-line me-2"></i>Primary Dataset </div><div class="comparison-body"><div id="primaryChartContainer" style="position: relative; height: 50vh; min-height: 400px;"><canvas id="primaryChart"></canvas></div></div></div><div class="comparison-chart"><div class="comparison-header"><i class="fas fa-chart-bar me-2"></i>Comparison Dataset </div><div class="comparison-body"><div id="comparisonChartContainer" style="position: relative; height: 50vh; min-height: 400px;"><canvas id="comparisonChart"></canvas></div></div></div></div></div>< !-- Grid Chart Layout (for multiple metrics) --><div id="gridChartLayout" class="chart-layout" style="display: none;">< !-- Grid Controls --><div class="card mb-3 shadow-sm"><div class="card-body py-2"><div class="d-flex justify-content-between align-items-center"><small class="text-muted"><i class="fas fa-th me-1"></i>Showing 6 key metrics simultaneously </small><div class="btn-group btn-group-sm"><button class="btn btn-outline-primary btn-sm" onclick="refreshAllGridCharts()"
    title="Refresh All Charts"><i class="fas fa-sync-alt"></i>Refresh All </button><button class="btn btn-outline-success btn-sm" onclick="exportGridChartsAsPDF()" title="Export as PDF"><i class="fas fa-file-pdf"></i>Export PDF </button></div></div></div></div>< !-- Grid of 6 Charts (2 rows x 3 columns) --><div class="row g-3 mb-4">< !-- Chart 1: Appointments per Tutor --><div class="col-lg-4 col-md-6"><div class="chart-container"><div class="chart-header"><h6 class="chart-title"><i class="fas fa-calendar-check me-2"></i>Appointments per Tutor </h6></div><div class="chart-body"><div id="gridChart1Container" style="position: relative; height: 280px;"><canvas id="gridChart1"></canvas></div></div></div></div>< !-- Chart 2: Hours per Tutor --><div class="col-lg-4 col-md-6"><div class="chart-container"><div class="chart-header"><h6 class="chart-title"><i class="fas fa-clock me-2"></i>Scheduled Hours per Tutor </h6></div><div class="chart-body"><div id="gridChart2Container" style="position: relative; height: 280px;"><canvas id="gridChart2"></canvas></div></div></div></div>< !-- Chart 3: Daily Appointments --><div class="col-lg-4 col-md-6"><div class="chart-container"><div class="chart-header"><h6 class="chart-title"><i class="fas fa-chart-line me-2"></i>Daily Appointments </h6></div><div class="chart-body"><div id="gridChart3Container" style="position: relative; height: 280px;"><canvas id="gridChart3"></canvas></div></div></div></div></div>< !-- Second Row of Charts --><div class="row g-3">< !-- Chart 4: Appointments by Status --><div class="col-lg-4 col-md-6"><div class="chart-container"><div class="chart-header"><h6 class="chart-title"><i class="fas fa-tasks me-2"></i>Appointments by Status </h6></div><div class="chart-body"><div id="gridChart4Container" style="position: relative; height: 280px;"><canvas id="gridChart4"></canvas></div></div></div></div>< !-- Chart 5: Course Popularity --><div class="col-lg-4 col-md-6"><div class="chart-container"><div class="chart-header"><h6 class="chart-title"><i class="fas fa-book me-2"></i>Course Popularity </h6></div><div class="chart-body"><div id="gridChart5Container" style="position: relative; height: 280px;"><canvas id="gridChart5"></canvas></div></div></div></div>< !-- Chart 6: Hourly Distribution --><div class="col-lg-4 col-md-6"><div class="chart-container"><div class="chart-header"><h6 class="chart-title"><i class="fas fa-business-time me-2"></i>Hourly Distribution </h6></div><div class="chart-body"><div id="gridChart6Container" style="position: relative; height: 280px;"><canvas id="gridChart6"></canvas></div></div></div></div></div></div>< !-- Chart Summary Table --><div id="chartSummaryTable" class="mt-4 table-responsive" style="max-height: 300px; overflow-y: auto;">< !-- Table will be populated by JavaScript --></div>< !-- Chart Insights Panel --><div id="chartInsights" class="mt-3" style="display: none;"><div class="alert alert-info"><h6 class="alert-heading"><i class="fas fa-lightbulb me-2"></i>Chart Insights </h6><div id="insightsContent">< !-- Insights will be populated by JavaScript --></div></div></div></div></div></div><div class="modal fade" id="chartsSnapshotModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content bg-dark"><div class="modal-header border-0"><button type="button" class="btn-close btn-close-white"
    data-bs-dismiss="modal"></button></div><div class="modal-body text-center p-0"><img id="chartsModalImage" class="img-fluid rounded" src=""
    alt="Snapshot" style="max-height: 80vh;" /></div></div></div></div>< !-- Move Bootstrap JS to the top of the script includes --><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script><script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js"></script><script src="/static/js/chart.js"></script><script> // Register Chart.js Zoom plugin globally

    if (window.Chart && window.Chart.register && window.ChartZoom) {
      Chart.register(window.ChartZoom);
    }

    // Enhanced Charts Functionality
    let currentChartLayout='single';

    let currentChartInstances= {}

    ;
    let comparisonMode=false;
    let filterPresets=JSON.parse(localStorage.getItem('chartFilterPresets') || '[]');

    // Analysis Mode Toggle
    document.addEventListener('DOMContentLoaded', function () {

        // Setup analysis mode toggle
        document.querySelectorAll('input[name="analysisMode"]').forEach(radio=> {
            radio.addEventListener('change', function () {
                comparisonMode=this.value==='comparison';
                toggleComparisonSection(comparisonMode);
                updateChartLayout();
              });
          });

        // Setup confidence level slider
        const confidenceSlider=document.getElementById('confidenceLevel');

        if (confidenceSlider) {
          confidenceSlider.addEventListener('input', function () {
              document.getElementById('confidenceLevelValue').textContent=this.value + '%';
            });
        }

        // Initialize chart layout buttons
        updateLayoutButtons();
        loadFilterPresets();

        // Setup new date range buttons
        setupNewDateRangeButtons();

        // Initialize comparison inputs
        toggleComparisonInputs();
      });

    function toggleComparisonSection(show) {
      const section=document.getElementById('comparisonSection');

      if (section) {
        section.style.display=show ? 'block': 'none';
      }

      // Also expand the advanced filters section when showing comparison
      if (show) {
        const advancedFilters=document.getElementById('advancedFilters');

        if (advancedFilters && !advancedFilters.classList.contains('show')) {
          const collapse=new bootstrap.Collapse(advancedFilters, {
            show: true
          });
      }
    }

    // Destroy existing charts when switching modes
    destroyAllCharts();

    // Update chart layout based on comparison mode
    if (show) {
      toggleChartLayout('split');
    }

    else {
      toggleChartLayout('single');
    }
    }

    function destroyAllCharts() {

      // Destroy main chart
      if (window.chartInstance) {
        window.chartInstance.destroy();
        window.chartInstance=null;
      }

      // Destroy comparison chart
      if (window.comparisonChartInstance) {
        window.comparisonChartInstance.destroy();
        window.comparisonChartInstance=null;
      }

      // Clear any canvas elements
      const canvases=document.querySelectorAll('canvas');

      canvases.forEach(canvas=> {
          const ctx=canvas.getContext('2d');
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        });
    }

    // Expose functions to global scope
    window.toggleComparisonSection=toggleComparisonSection;
    window.updateComparisonChart=updateComparisonChart;
    window.updateFilterChips=updateFilterChips;
    window.toggleChartLayout=toggleChartLayout;
    window.switchChartType=switchChartType;

    // Chart Layout Management
    function toggleChartLayout(layout) {
      currentChartLayout=layout;
      updateLayoutButtons();
      updateChartLayout();
    }

    function updateLayoutButtons() {

      ['single',
      'split',
      'grid'].forEach(layout=> {
          const btn=document.getElementById(layout + 'LayoutBtn');

          if (btn) {
            btn.classList.toggle('active', currentChartLayout===layout);
            btn.classList.toggle('btn-primary', currentChartLayout===layout);
            btn.classList.toggle('btn-outline-primary', currentChartLayout !==layout);
          }
        });
    }

    function updateChartLayout() {

      // Hide all layouts
      document.querySelectorAll('.chart-layout').forEach(layout=> {
          layout.style.display='none';
        });

      // Show selected layout
      const selectedLayout=document.getElementById(currentChartLayout + 'ChartLayout');

      if (selectedLayout) {
        selectedLayout.style.display='block';
      }

      // Clear existing chart instances
      Object.values(currentChartInstances).forEach(chart=> {
          if (chart && chart.destroy) {
            chart.destroy();
          }
        });

      currentChartInstances= {}

      ;

      // Trigger chart refresh for the new layout
      setTimeout(()=> {
          const form=document.getElementById('filterForm');

          if (form) {
            form.dispatchEvent(new Event('submit', {
                bubbles: true
              }));
        }
      }

      , 100);
    }

    // Chart Type Switching
    function switchChartType(type) {
      const chartTypeSelect=document.getElementById('chartTypeSelect');

      if (chartTypeSelect) {

        // Update the select value
        for (let option of chartTypeSelect.options) {
          if (option.value===type) {
            chartTypeSelect.value=type;
            break;
          }
        }

        // Trigger chart update
        refreshChart();
      }
    }

    // Chart Controls
    function refreshChart() {
      showLoadingIndicator(true);

      // Trigger form submission to reload chart
      const form=document.getElementById('filterForm');

      if (form) {
        const event=new Event('submit');
        form.dispatchEvent(event);
      }

      setTimeout(()=> showLoadingIndicator(false), 1000);
    }


    function zoomChart(direction) {
      Object.values(currentChartInstances).forEach(chart=> {
          if (chart && chart.zoom) {
            const zoomPlugin=chart.getPlugin('zoom');

            if (zoomPlugin) {
              if (direction==='in') {
                zoomPlugin.zoom(1.1);
              }

              else if (direction==='out') {
                zoomPlugin.zoom(0.9);
              }
            }
          }
        });
    }

    function resetChartZoom() {
      Object.values(currentChartInstances).forEach(chart=> {
          if (chart && chart.resetZoom) {
            const zoomPlugin=chart.getPlugin('zoom');

            if (zoomPlugin) {
              zoomPlugin.resetZoom();
            }
          }
        });
    }

    function toggleChartFullscreen() {
      const chartContainer=document.querySelector('.chart-container-enhanced');

      if (chartContainer) {
        if (document.fullscreenElement) {
          document.exitFullscreen();
        }

        else {
          chartContainer.requestFullscreen();
        }
      }
    }

    // Centralized function to collect all advanced filters
    function collectAdvancedFilters() {
      return {
        minHours: document.getElementById('minHours')?.value || '',
          maxHours: document.getElementById('maxHours')?.value || '',
          minSessions: document.getElementById('minSessions')?.value || '',
          maxSessions: document.getElementById('maxSessions')?.value || '',
          sessionPattern: document.getElementById('sessionPattern')?.value || '',
          timeOfDay: document.getElementById('timeOfDay')?.value || '',
          excludeWeekends: document.getElementById('excludeWeekends')?.checked || false,
          excludeHolidays: document.getElementById('excludeHolidays')?.checked || false,
          outlierHandling: document.getElementById('outlierHandling')?.value || 'include',
          aggregationMethod: document.getElementById('aggregationMethod')?.value || 'sum',
          confidenceLevel: document.getElementById('confidenceLevel')?.value || 95
      }

      ;
    }

    // Advanced Filters
    function applyAdvancedFilters() {
      // Collect advanced filter values
      const advancedFilters=collectAdvancedFilters();

      console.log('Advanced filters being applied:', advancedFilters); // Debug log

      // Store in session storage for use by chart generation
      sessionStorage.setItem('advancedFilters', JSON.stringify(advancedFilters));

      // Update filter chips
      updateFilterChips(); // This now includes both normal and advanced filters

      // Refresh chart by triggering form submission
      const form=document.getElementById('filterForm');

      if (form) {
        form.dispatchEvent(new Event('submit', {
            bubbles: true
          }));
    }

    // Show success message
    showToast('Advanced filters applied successfully', 'success');
    }

    function clearAdvancedFilters() {
      // Reset all advanced filter inputs
      document.getElementById('minHours').value='';
      document.getElementById('maxHours').value='';
      document.getElementById('minSessions').value='';
      document.getElementById('maxSessions').value='';
      document.getElementById('sessionPattern').value='';
      document.getElementById('timeOfDay').value='';
      document.getElementById('excludeWeekends').checked=false;
      document.getElementById('excludeHolidays').checked=false;
      document.getElementById('outlierHandling').value='include';
      document.getElementById('aggregationMethod').value='sum';
      document.getElementById('confidenceLevel').value=95;
      document.getElementById('confidenceLevelValue').textContent='95%';

      // Clear from session storage
      sessionStorage.removeItem('advancedFilters');

      // Update filter chips (this now includes both normal and advanced filters)
      updateFilterChips();

      // Refresh chart by triggering form submission
      const form=document.getElementById('filterForm');

      if (form) {
        form.dispatchEvent(new Event('submit', {
            bubbles: true
          }));
    }

    showToast('Advanced filters cleared', 'info');
    }

    // Filter Presets
    function saveFilterPreset() {
      const presetName=prompt('Enter a name for this filter preset:');
      if ( !presetName) return;

      const form=document.getElementById('filterForm');
      const formData=new FormData(form);

      const preset= {
        name: presetName,
        timestamp: new Date().toISOString(),
        filters: Object.fromEntries(formData),
        advancedFilters: JSON.parse(sessionStorage.getItem('advancedFilters') || '{}')
      }

      ;

      filterPresets.push(preset);
      localStorage.setItem('chartFilterPresets', JSON.stringify(filterPresets));
      loadFilterPresets();

      showToast(`Filter preset "${presetName}" saved successfully`, 'success');
    }

    function loadFilterPresets() {
      const presetsMenu=document.getElementById('filterPresets');
      if ( !presetsMenu) return;

      if (filterPresets.length===0) {
        presetsMenu.innerHTML='<li><span class="dropdown-item-text text-muted">No saved presets</span></li>';
        return;
      }

      presetsMenu.innerHTML=filterPresets.map((preset, index)=> ` <li> <a class="dropdown-item d-flex justify-content-between align-items-center" href="#" onclick="applyFilterPreset(${index})" > <span> <strong>$ {
          preset.name
        }

        </strong> <br><small class="text-muted" >$ {
          new Date(preset.timestamp).toLocaleDateString()
        }

        </small> </span> <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteFilterPreset(${index})" title="Delete" > <i class="fas fa-trash" ></i> </button> </a> </li> `).join('');
    }

    function applyFilterPreset(index) {
      const preset=filterPresets[index];
      if ( !preset) return;

      // Apply basic filters
      const form=document.getElementById('filterForm');

      Object.entries(preset.filters).forEach(([key, value])=> {
          const element=form.elements[key];

          if (element) {
            element.value=value;
          }
        });

      // Apply advanced filters
      if (preset.advancedFilters) {
        Object.entries(preset.advancedFilters).forEach(([key, value])=> {
            const element=document.getElementById(key);

            if (element) {
              if (element.type==='checkbox') {
                element.checked=value;
              }

              else {
                element.value=value;
              }
            }
          });
        sessionStorage.setItem('advancedFilters', JSON.stringify(preset.advancedFilters));
      }

      // Update UI
      updateFilterChips();
      refreshChart();

      showToast(`Filter preset "${preset.name}" applied`, 'success');
    }

    function deleteFilterPreset(index) {
      if (confirm('Are you sure you want to delete this preset?')) {
        filterPresets.splice(index, 1);
        localStorage.setItem('chartFilterPresets', JSON.stringify(filterPresets));
        loadFilterPresets();
        showToast('Filter preset deleted', 'info');
      }
    }

    // Utility Functions
    function showToast(message, type='info') {
      // Create toast element
      const toast=document.createElement('div');

      toast.className=`alert alert-$ {
        type
      }

      alert-dismissible fade show position-fixed`;
      toast.style.cssText='top: 20px; right: 20px; z-index: 9999; min-width: 300px;';

      toast.innerHTML=` $ {
        message
      }

      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;

      document.body.appendChild(toast);

      // Auto remove after 3 seconds
      setTimeout(()=> {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }

        , 3000);
    }

    // Quick Date Range Functions
    function setDateRange(startDate, endDate) {
      document.getElementById('start_date').value=startDate;
      document.getElementById('end_date').value=endDate;
      updateFilterChips();
    }

    function setupNewDateRangeButtons() {
      document.getElementById('last30DaysBtn')?.addEventListener('click', ()=> {
          const end=new Date();
          const start=new Date();
          start.setDate(start.getDate() - 30);
          setDateRange(start.toISOString().split('T')[0], end.toISOString().split('T')[0]);
        });

      document.getElementById('lastQuarterBtn')?.addEventListener('click', ()=> {
          const end=new Date();
          const start=new Date();
          start.setMonth(start.getMonth() - 3);
          setDateRange(start.toISOString().split('T')[0], end.toISOString().split('T')[0]);
        });

      document.getElementById('thisYearBtn')?.addEventListener('click', ()=> {
          const now=new Date();
          const start=new Date(now.getFullYear(), 0, 1);
          setDateRange(start.toISOString().split('T')[0], now.toISOString().split('T')[0]);
        });
    }


    function formatFilterLabel(key) {
      const labels= {
        minHours: 'Min Hours',
          maxHours: 'Max Hours',
          minSessions: 'Min Sessions',
          maxSessions: 'Max Sessions',
          sessionPattern: 'Pattern',
          timeOfDay: 'Time of Day',
          excludeWeekends: 'Exclude Weekends',
          excludeHolidays: 'Exclude Holidays',
          outlierHandling: 'Outliers',
          aggregationMethod: 'Aggregation',
          confidenceLevel: 'Confidence'
      }

      ;
      return labels[key] || key;
    }

    function formatFilterValue(key, value) {
      if (key==='excludeWeekends' || key==='excludeHolidays') {
        return value ? 'Yes': 'No';
      }

      if (key==='confidenceLevel') {
        return value+'%';
      }

      return value;
    }

    // Ensure theme persists and dashboard header styles are maintained
    function ensureThemePersistence() {
      const html=document.documentElement;
      const savedTheme=localStorage.getItem('theme') || 'light';

      // Ensure data-theme attribute is set and matches saved theme
      const currentTheme=html.getAttribute('data-theme');

      if ( !currentTheme || currentTheme !==savedTheme) {
        html.setAttribute('data-theme', savedTheme);
      }
    }

    // Watch for theme attribute changes and restore if removed
    const themeObserver=new MutationObserver((mutations)=> {
        mutations.forEach((mutation)=> {
            if (mutation.type==='attributes' && mutation.attributeName==='data-theme') {
              const html=document.documentElement;
              const savedTheme=localStorage.getItem('theme') || 'light';
              const currentTheme=html.getAttribute('data-theme');

              // If theme was removed or changed unexpectedly, restore it
              if ( !currentTheme || (currentTheme !==savedTheme && !document.querySelector('#theme-toggle:active'))) {
                setTimeout(()=> {
                    html.setAttribute('data-theme', savedTheme);
                    forceApplyDashboardStyles();
                  }

                  , 100);
              }

              else {
                // Theme changed legitimately, update styles
                forceApplyDashboardStyles();
              }
            }
          });
      });

    // Also watch for style changes on dashboard header and navbar
    const styleObserver=new MutationObserver(()=> {
        forceApplyDashboardStyles();
      });

    // Start observing theme changes
    themeObserver.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-theme']
    });

    // Observe dashboard header and navbar for style changes
    document.addEventListener('DOMContentLoaded', ()=> {
        const dashboardHeader=document.querySelector('.dashboard-header');
        const navbar=document.querySelector('.charts-navbar');

        if (dashboardHeader) {
          styleObserver.observe(dashboardHeader, {
            attributes: true,
            attributeFilter: ['style', 'class']
          });
      }

      if (navbar) {
        styleObserver.observe(navbar, {
          attributes: true,
          attributeFilter: ['style', 'class']
        });
    }
    });

    // Continuous style enforcement
    setInterval(()=> {
        forceApplyDashboardStyles();
      }

      , 2000);

    // Function to force apply dashboard styles
    function forceApplyDashboardStyles() {
      const dashboardHeader=document.querySelector('.dashboard-header');
      const navbar=document.querySelector('.charts-navbar');

      if (dashboardHeader) {
        const isDark=document.documentElement.getAttribute('data-theme')==='dark';
        dashboardHeader.style.setProperty('background',
          isDark ? 'linear-gradient(135deg, #3730a3 0%, #5b21b6 60%, #7c3aed 100%)'
          : 'linear-gradient(135deg, #6a77e8 0%, #7a68b6 60%, #e08cf6 100%)',
          'important'
        );
        dashboardHeader.style.setProperty('display', 'block', 'important');
        dashboardHeader.style.setProperty('visibility', 'visible', 'important');
        dashboardHeader.style.setProperty('opacity', '1', 'important');
      }

      if (navbar) {
        const isDark=document.documentElement.getAttribute('data-theme')==='dark';
        navbar.style.setProperty('background',
          isDark ? 'linear-gradient(135deg, #3730a3 0%, #5b21b6 60%, #7c3aed 100%)'
          : 'linear-gradient(135deg, #6a77e8 0%, #7a68b6 55%, #e08cf6 100%)',
          'important'
        );
        navbar.style.setProperty('display', 'block', 'important');
        navbar.style.setProperty('visibility', 'visible', 'important');
        navbar.style.setProperty('opacity', '1', 'important');
      }
    }

    // Run immediately and on DOMContentLoaded
    ensureThemePersistence();
    forceApplyDashboardStyles();

    document.addEventListener('DOMContentLoaded', ()=> {
        ensureThemePersistence();
        forceApplyDashboardStyles();

        // Re-check theme and styles after delays to catch any late changes
        setTimeout(()=> {
            ensureThemePersistence();
            forceApplyDashboardStyles();
          }

          , 100);

        setTimeout(()=> {
            ensureThemePersistence();
            forceApplyDashboardStyles();
          }

          , 500);

        setTimeout(()=> {
            ensureThemePersistence();
            forceApplyDashboardStyles();
          }

          , 1000);

        setTimeout(()=> {
            ensureThemePersistence();
            forceApplyDashboardStyles();
          }

          , 2000);
        updateFilterChips();
        document.getElementById('filterForm').addEventListener('submit', handleFormSubmit);
        initializeTutorSelector();

        // Load initial chart data
        console.log('Loading initial chart data...');
        console.log('renderChart function available:', typeof window.renderChart);
        loadChartData();
      });

    // Handle form submission with debouncing
    const debouncedHandleFormSubmit=debounce(function (event) {
        event.preventDefault();
        updateFilterChips();

        // Check if comparison mode is enabled
        const comparisonMode=document.querySelector('input[name="analysisMode"]:checked')?.value==='comparison';

        if (comparisonMode) {
          loadComparisonData();
        }

        else {
          loadChartData();
        }
      }

      , 300);

    function handleFormSubmit(event) {
      debouncedHandleFormSubmit(event);
    }

    // Loading state management
    let isLoading=false;

    // Chart titles mapping is defined in chart.js

    // Load chart data with current form values
    function loadChartData() {

      // Prevent multiple simultaneous requests
      if (isLoading) {
        console.log('Request already in progress, skipping...');
        return;
      }

      isLoading=true;
      const form=document.getElementById('filterForm');
      const formData=new FormData(form);

      // Convert FormData to object
      const payload= {}

      ;

      for (let [key, value] of formData.entries()) {
        payload[key]=value;
      }

      // Debug: Log all form data
      console.log('Form data entries:');

      for (let [key, value] of formData.entries()) {
        console.log(`$ {
            key
          }

          : $ {
            value
          }

          `);
      }

      // Add dataset and chart_type from current controls
      const datasetEl=document.getElementById('dataset');
      const chartTypeEl=document.getElementById('chartTypeSelect');
      if (datasetEl) payload.dataset=datasetEl.value;
      if (chartTypeEl) payload.chart_type=chartTypeEl.value;

      // Add advanced filters to payload using centralized collection
      const advancedFilters=collectAdvancedFilters();

      Object.entries(advancedFilters).forEach(([key, value])=> {
          if (value && value !=='' && value !==false) {
            payload[key]=value;
          }
        });

      console.log('Submitting form with payload:', payload);
      console.log('Selected tutors:', selectedTutors);
      console.log('Tutor IDs string:', document.getElementById('tutor_id')?.getAttribute('data-selected-ids'));

      // Show loading indicator
      showLoadingIndicator(true);

      fetch('{{ url_for("analytics.chart_data") }}', {

        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }

        ,
        body: JSON.stringify(payload)

      }) .then(response=> {
        if ( !response.ok) throw new Error(`HTTP error ! status: $ {
            response.status
          }

          `);
        return response.json();

      }) .then(data=> {
        console.log('Chart data received:', data);
        updateChart(data);
        showLoadingIndicator(false);
        isLoading=false;

      }) .catch(error=> {
        console.error('Error loading chart data:', error);
        showError('Failed to load chart data: ' + error.message);
        showLoadingIndicator(false);
        isLoading=false;
      });
    }

    // Toggle comparison input fields based on comparison type
    function toggleComparisonInputs() {
      const comparisonType=document.getElementById('comparisonType')?.value || 'time_periods';

      // Hide all input sections
      document.getElementById('timePeriodInputs').style.display='none';
      document.getElementById('tutorsInputs').style.display='none';
      document.getElementById('dayTypesInputs').style.display='none';
      document.getElementById('durationRangesInputs').style.display='none';

      // Show relevant input section
      switch (comparisonType) {
        case 'time_periods':
          document.getElementById('timePeriodInputs').style.display='block';
        break;
        case 'tutors':
          document.getElementById('tutorsInputs').style.display='block';
        break;
        case 'day_types':
          document.getElementById('dayTypesInputs').style.display='block';
        break;
        case 'duration_ranges':
          document.getElementById('durationRangesInputs').style.display='block';
        break;
      }
    }

    // Load comparison data
    function loadComparisonData() {

      // Prevent multiple simultaneous requests
      if (isLoading) {
        console.log('Request already in progress, skipping...');
        return;
      }

      isLoading=true;

      // Ensure comparison section is visible
      const comparisonSection=document.getElementById('comparisonSection');

      if (comparisonSection) {
        comparisonSection.style.display='block';
      }

      const form=document.getElementById('filterForm');
      const formData=new FormData(form);

      // Convert FormData to object
      const payload= {}

      ;

      for (let [key, value] of formData.entries()) {
        payload[key]=value;
      }

      // Add dataset parameter
      payload.dataset='checkins_per_tutor';
      payload.mode='comparison';

      // Add comparison parameters - get values directly from elements
      const comparisonType=document.getElementById('comparisonType')?.value || 'time_periods';
      payload.comparisonType=comparisonType;

      // Handle different comparison types
      if (comparisonType==='time_periods') {
        const period1Start=document.getElementById('period1Start')?.value;
        const period1End=document.getElementById('period1End')?.value;
        const period2Start=document.getElementById('period2Start')?.value;
        const period2End=document.getElementById('period2End')?.value;

        // Check if required parameters are present
        if ( !period1Start || !period1End || !period2Start || !period2End) {
          showError('Please fill in all comparison date fields (Period 1 and Period 2)');
          return;
        }

        payload.period1Start=period1Start;
        payload.period1End=period1End;
        payload.period2Start=period2Start;
        payload.period2End=period2End;

      }

      else if (comparisonType==='tutors') {
        // Get selected tutors from the main filter
        const tutorIds=document.getElementById('tutor_id')?.getAttribute('data-selected-ids') || '';

        if ( !tutorIds || tutorIds.split(',').length < 2) {
          showError('Please select at least 2 tutors for comparison');
          return;
        }

        payload.tutor_ids=tutorIds;

      }

      else if (comparisonType==='day_types' || comparisonType==='duration_ranges') {
        // These comparison types use the current date range and filters
        // No additional parameters needed
      }

      // Add advanced filters to payload using centralized collection
      const advancedFilters=collectAdvancedFilters();

      Object.entries(advancedFilters).forEach(([key, value])=> {
          if (value && value !=='' && value !==false) {
            payload[key]=value;
          }
        });

      console.log('Submitting comparison data with payload:', payload);

      // Show loading indicator
      showLoadingIndicator(true);

      fetch('/chart-data', {

        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }

        ,
        body: JSON.stringify(payload)

      }) .then(response=> {
        if ( !response.ok) throw new Error(`HTTP error ! status: $ {
            response.status
          }

          `);
        return response.json();

      }) .then(data=> {
        console.log('Comparison data received:', data);
        updateComparisonChart(data);
        showLoadingIndicator(false);
        isLoading=false;

      }) .catch(error=> {
        console.error('Error loading comparison data:', error);
        showError('Failed to load comparison data: ' + error.message);
        showLoadingIndicator(false);
        isLoading=false;
      });
    }

    // Update comparison chart with new data (throttled)
    const throttledUpdateComparisonChart=throttle(function (data) {
        console.log('Updating comparison chart with data:', data);

        // Update metrics if available
        if (data.raw_records_for_chart_context) {
          updateChartMetrics(data);
        }

        // Check for errors
        if (data.error) {
          showError(data.error);
          return;
        }

        // Render comparison charts
        if (data.primary_data && data.comparison_data) {

          // Switch to split layout for comparison
          if (typeof window.toggleComparisonSection==='function') {
            window.toggleComparisonSection(true);
          }

          // Render primary chart
          if (data.primary_data.chart_data && data.primary_data.chart_type) {
            if (typeof window.renderChart==='function') {
              window.renderChart(data.primary_data.chart_type, data.primary_data.chart_data, data.primary_data.title || 'Primary Dataset', true);
            }

            else {
              console.error('renderChart function not found in global scope');
              showError('Chart rendering function not available');
            }
          }

          // Render comparison chart in the second container
          if (data.comparison_data.chart_data && data.comparison_data.chart_type) {
            // Find the comparison chart container
            const comparisonCtx=document.getElementById('comparisonChart')?.getContext('2d');

            if (comparisonCtx && typeof window.createChartInstance==='function') {

              // Destroy existing comparison chart
              if (window.comparisonChartInstance) {
                window.comparisonChartInstance.destroy();
              }

              // Create new comparison chart
              window.comparisonChartInstance=window.createChartInstance(comparisonCtx,
                data.comparison_data.chart_type,
                data.comparison_data.chart_data,
                data.comparison_data.title || 'Comparison Dataset',
                true);
            }

            else {
              console.log('Comparison chart container not found or createChartInstance not available');
            }
          }
        }

        else {
          console.error('Invalid comparison data structure:', data);
          showError('Invalid comparison data received from server');
        }
      }

      , 500);

    function updateComparisonChart(data) {
      throttledUpdateComparisonChart(data);
    }

    // Update chart with new data (throttled to prevent rapid updates)
    const throttledUpdateChart=throttle(function (data) {
        console.log('Updating chart with data:', data);

        console.log('Data structure check:', {
          hasChartData: ! !data.chart_data,
          hasChartType: ! !data.chart_type,
          hasTitle: ! !data.title,
          hasDataset: ! !data.dataset,
          renderChartAvailable: typeof window.renderChart
        });

      // Destroy existing main chart before creating new one
      if (window.chartInstance) {
        window.chartInstance.destroy();
        window.chartInstance=null;
      }

      // Update metrics if available
      if (data.raw_records_for_chart_context) {
        updateChartMetrics(data);
      }

      // Ensure chart container exists
      const chartContainer=document.getElementById('tutorChartContainer');

      if ( !chartContainer) {
        console.error('Chart container not found');
        showError('Chart container not found');
        return;
      }

      // Ensure canvas exists
      let canvas=document.getElementById('tutorChart');

      if ( !canvas) {
        console.log('Creating new canvas element');
        canvas=document.createElement('canvas');
        canvas.id='tutorChart';
        chartContainer.innerHTML='';
        chartContainer.appendChild(canvas);
      }

      // Render the chart based on the data
      if (data.chart_data && data.chart_type && data.title) {

        // Call renderChart from the global scope (defined in chart.js)
        if (typeof window.renderChart==='function') {
          console.log('Rendering chart with data:', data.chart_type, data.title);
          window.renderChart(data.chart_type, data.chart_data, data.title, false, data.forecast_data);
        }

        else {
          console.error('renderChart function not found in global scope');
          showError('Chart rendering function not available');
        }
      }

      else if (data.dataset && data.chart_data) {
        // Fallback for different data structure
        const chartType=data.chart_type || 'bar';
        const title=data.title || window.chartTitles?.[data.dataset] || 'Chart';

        if (typeof window.renderChart==='function') {
          console.log('Rendering chart with fallback data:', chartType, title);
          window.renderChart(chartType, data.chart_data, title, false, data.forecast_data);
        }

        else {
          console.error('renderChart function not found in global scope');
          showError('Chart rendering function not available');
        }
      }

      else {
        console.error('Invalid chart data structure:', data);
        showError('Invalid chart data received from server');
      }
    }

    , 500);

    function updateChart(data) {
      throttledUpdateChart(data);
    }

    // Show/hide loading indicator
    function showLoadingIndicator(show) {
      const loadingDiv=document.getElementById('loadingIndicator');
      const chartIndicator=document.getElementById('chartLoadingIndicator');

      if (loadingDiv) {
        loadingDiv.style.display=show ? 'block': 'none';
      }

      if (chartIndicator) {
        chartIndicator.style.display=show ? 'inline-block': 'none';
      }
    }

    // Show error message
    function showError(message) {
      console.error(message);
      // You can implement a proper error display here
      alert(message);
    }

    // Multi-select tutor functionality
    let selectedTutors=[];
    let allTutors=[];

    async function initializeTutorSelector() {
      try {
        const response=await fetch('{{ url_for("analytics.get_tutors") }}');
        allTutors=await response.json();
        populateTutorDropdown(allTutors);
        setupTutorSearch();
      }

      catch (error) {
        console.error('Error loading tutors:', error);
        document.getElementById('tutorDropdown').innerHTML='<div class="px-2 py-1 text-danger small">Error loading tutors</div>';
      }
    }

    function populateTutorDropdown(tutors) {
      const dropdown=document.getElementById('tutorDropdown');

      if (tutors.length===0) {
        dropdown.innerHTML='<div class="px-2 py-1 text-muted small">No tutors found</div>';
        return;
      }

      // Add control buttons
      const controlButtons=` <div class="dropdown-item-text border-bottom mb-1 pb-1"><small class="text-muted d-flex justify-content-between"><span class="btn btn-link btn-sm p-0" onclick="selectAllTutors()">Select All</span><span class="btn btn-link btn-sm p-0" onclick="clearAllTutors()">Clear All</span></small></div>`;

      const tutorItems=tutors.map(tutor=> `<div class="dropdown-item tutor-option" data-tutor-id="${tutor.tutor_id}" data-tutor-name="${tutor.tutor_name}" > <strong>$ {
          tutor.tutor_name
        }

        </strong> <small class="text-muted" >(ID: $ {
            tutor.tutor_id
          })</small> </div>`).join('');

      dropdown.innerHTML=controlButtons+tutorItems;

      // Add click event listeners to dropdown items
      dropdown.querySelectorAll('.tutor-option').forEach(item=> {
          item.addEventListener('click', (e)=> {
              e.preventDefault();
              const tutorId=item.getAttribute('data-tutor-id');
              const tutorName=item.getAttribute('data-tutor-name');
              addTutor(tutorId, tutorName);
              document.getElementById('tutor_id').value='';
            });
        });
    }

    function selectAllTutors() {
      allTutors.forEach(tutor=> {
          addTutor(tutor.tutor_id, tutor.tutor_name);
        });
      document.getElementById('tutor_id').blur();
    }

    function clearAllTutors() {
      selectedTutors=[];
      updateSelectedTutorsDisplay();
      updateTutorIdInput();
      document.getElementById('tutor_id').blur();
    }

    function setupTutorSearch() {
      const searchInput=document.getElementById('tutor_id');

      searchInput.addEventListener('input', (e)=> {
          const searchTerm=e.target.value.toLowerCase();
          const filteredTutors=allTutors.filter(tutor=> tutor.tutor_name.toLowerCase().includes(searchTerm) || tutor.tutor_id.toString().includes(searchTerm));
          populateTutorDropdown(filteredTutors);
        });

      // Show dropdown when input is focused
      searchInput.addEventListener('focus', ()=> {
          populateTutorDropdown(allTutors);
        });
    }

    function addTutor(tutorId, tutorName) {

      // Check if tutor is already selected
      if (selectedTutors.find(t=> t.id===tutorId)) {
        return;
      }

      selectedTutors.push({
        id: tutorId, name: tutorName
      });
    updateSelectedTutorsDisplay();
    updateTutorIdInput();
    }

    function removeTutor(tutorId) {
      selectedTutors=selectedTutors.filter(t=> t.id !==tutorId);
      updateSelectedTutorsDisplay();
      updateTutorIdInput();
    }

    function updateSelectedTutorsDisplay() {
      const container=document.getElementById('selectedTutors');

      container.innerHTML=selectedTutors.map(tutor=> `<span class="tutor-chip" > $ {
          tutor.name
        }

        ($ {
            tutor.id
          }) <span class="remove-btn" onclick="removeTutor('${tutor.id}')" >&times; </span> </span>`).join('');
    }

    function updateTutorIdInput() {
      const tutorIds=selectedTutors.map(t=> t.id).join(',');
      document.getElementById('tutor_id').setAttribute('data-selected-ids', tutorIds);

      // Update the form data for submission
      const form=document.getElementById('filterForm');
      let hiddenInput=form.querySelector('input[name="tutor_ids"]');

      if ( !hiddenInput) {
        hiddenInput=document.createElement('input');
        hiddenInput.type='hidden';
        hiddenInput.name='tutor_ids';
        form.appendChild(hiddenInput);
      }

      hiddenInput.value=tutorIds;
    }

    // Update the filter chips function to show selected tutors
    function updateFilterChips() {
      const form=document.getElementById('filterForm');
      const chipsDiv=document.getElementById('filterChips');
      chipsDiv.innerHTML='';

      const createChip=(label, value, displayValue=null, isAdvanced=false)=> {
        if (value && String(value).trim() !=='') {
          const chip=document.createElement('span');

          chip.className=`filter-chip $ {
            isAdvanced ? 'advanced-chip': ''
          }

          `;

          chip.textContent=`$ {
            label
          }

          : $ {
            displayValue || value
          }

          `;
          chipsDiv.appendChild(chip);
        }
      }

      ;

      // Show selected tutors
      if (selectedTutors.length > 0) {
        const tutorNames=selectedTutors.map(t=> t.name).join(', ');
        createChip("Tutors", tutorNames);
      }

      // Normal filters
      createChip("From", form.start_date.value);
      createChip("To", form.end_date.value);
      const durationSelect=form.duration;
      if (durationSelect.value) createChip("Duration", durationSelect.options[durationSelect.selectedIndex].text);
      const dayTypeSelect=form.day_type;
      if (dayTypeSelect.value) createChip("Day Type", dayTypeSelect.options[dayTypeSelect.selectedIndex].text);
      const shiftStartHour=document.getElementById('shift_start_hour').value;
      const shiftEndHour=document.getElementById('shift_end_hour').value;

      if (shiftStartHour !=="0" || shiftEndHour !=="23") createChip("Check-In Time", `$ {
          String(shiftStartHour).padStart(2, '0')
        }

        :00 - $ {
          String(shiftEndHour).padStart(2, '0')
        }

        :00`);

      // Advanced filters
      const advancedFilters=collectAdvancedFilters();

      Object.entries(advancedFilters).forEach(([key, value])=> {
          if (value && value !=='' && value !==false) {
            createChip(formatFilterLabel(key), formatFilterValue(key, value), null, true);
          }
        });
    }

    // Enhanced Analytics Functions
    let currentMetrics= {}

    ;

    // Advanced Filters Functions (duplicate removed - using the one above)

    function addFilterChip(label, value) {
      const chipsDiv=document.getElementById('filterChips');
      const chip=document.createElement('span');
      chip.className='filter-chip';

      chip.textContent=`$ {
        label
      }

      : $ {
        value
      }

      `;
      chipsDiv.appendChild(chip);
    }

    // Metrics Update Functions (for charts context)
    function updateChartMetrics(data) {
      if ( !data || !data.raw_records_for_chart_context) return;
      const records=data.raw_records_for_chart_context;
      const totalCheckins=records.length;
      const totalHours=records.reduce((sum, record)=> sum + (parseFloat(record.shift_hours) || 0), 0);
      const avgSession=totalCheckins>0 ? (totalHours / totalCheckins): 0;
      const activeTutors=new Set(records.map(r=> r.tutor_id)).size;

      currentMetrics= {
        totalCheckins,
        totalHours,
        avgSession,
        activeTutors,
        records
      }

      ;
    }

    // Chart Enhancement Functions
    function refreshChart() {
      const form=document.getElementById('filterForm');

      form.dispatchEvent(new Event('submit', {
          bubbles: true
        }));
    }

    function toggleChartFullscreen() {
      const chartContainer=document.querySelector('.chart-container-enhanced');

      if (chartContainer) {
        if (document.fullscreenElement) {
          document.exitFullscreen();
        }

        else {
          chartContainer.requestFullscreen();
        }
      }
    }

    function zoomChart(direction) {
      // Apply zoom to all active chart instances
      const allCharts=[tutorChart,
      ...Object.values(currentChartInstances)];

      allCharts.forEach(chart=> {
          if (chart && chart.zoom) {
            if (direction==='in') {
              chart.zoom(1.2);
            }

            else if (direction==='out') {
              chart.zoom(0.8);
            }
          }
        });
    }

    function resetChartZoom() {
      // Reset zoom for all active chart instances
      const allCharts=[tutorChart,
      ...Object.values(currentChartInstances)];

      allCharts.forEach(chart=> {
          if (chart && chart.resetZoom) {
            chart.resetZoom();
          }
        });
    }

    // Grid Chart Functions
    function refreshAllGridCharts() {
      if (currentChartLayout !=='grid') {
        toggleChartLayout('grid');
        return;
      }

      showLoadingIndicator(true);

      // Trigger form submission to reload all grid charts
      const form=document.getElementById('filterForm');

      if (form) {
        form.dispatchEvent(new Event('submit', {
            bubbles: true
          }));
    }

    setTimeout(()=> showLoadingIndicator(false), 1500);
    }

    function exportGridChartsAsPDF() {

      // Export all 6 grid charts as a single PDF
      if (currentChartLayout !=='grid') {
        alert('Please switch to Grid layout first');
        return;
      }

      const gridCharts=['gridChart1',
      'gridChart2',
      'gridChart3',
      'gridChart4',
      'gridChart5',
      'gridChart6'];
      const charts=gridCharts.map(id=> currentChartInstances[id]).filter(chart=> chart && chart.canvas);

      if (charts.length===0) {
        alert('No charts to export');
        return;
      }

      // For now, export as images (PDF would require a library like jsPDF)
      charts.forEach((chart, index)=> {
          const url=chart.toBase64Image();
          const link=document.createElement('a');

          link.download=`grid_chart_$ {
            index + 1
          }

          .png`;
          link.href=url;
          link.click();
        });

      showToast(`Exported $ {
          charts.length
        }

        charts as images`, 'success');
    }

    // Debounce function to prevent rapid calls
    function debounce(func, wait) {
      let timeout;

      return function executedFunction(...args) {
        const later=()=> {
          clearTimeout(timeout);
          func(...args);
        }

        ;
        clearTimeout(timeout);
        timeout=setTimeout(later, wait);
      }

      ;
    }

    // Throttle function to limit calls
    function throttle(func, limit) {
      let inThrottle;

      return function () {
        const args=arguments;
        const context=this;

        if ( !inThrottle) {
          func.apply(context, args);
          inThrottle=true;
          setTimeout(()=> inThrottle=false, limit);
        }
      }

      ;
    }


    </script><script> // Remove any duplicate navbars - ensure only our custom navbar exists

    (function () {
        function removeDuplicateNavbars() {
          const navbars=document.querySelectorAll('nav.navbar');
          const chartsNavbar=document.getElementById('charts-navbar');

          if (navbars.length > 1 && chartsNavbar) {

            // Keep only our custom charts navbar, remove all others
            navbars.forEach(nav=> {
                if (nav !==chartsNavbar && nav.id !=='charts-navbar') {
                  console.log('Removing duplicate navbar:', nav);
                  nav.remove();
                }
              });
          }
        }

        // Run immediately
        removeDuplicateNavbars();

        // Run on DOMContentLoaded
        if (document.readyState==='loading') {
          document.addEventListener('DOMContentLoaded', removeDuplicateNavbars);
        }

        // Run after a short delay to catch late-injected navbars
        setTimeout(removeDuplicateNavbars, 100);
        setTimeout(removeDuplicateNavbars, 500);
        setTimeout(removeDuplicateNavbars, 1000);

        // Watch for new navbars being added
        const navbarObserver=new MutationObserver(()=> {
            removeDuplicateNavbars();
          });

        navbarObserver.observe(document.body, {
          childList: true,
          subtree: true
        });
    })();
    </script></body></html>